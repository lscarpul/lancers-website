<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Presenze - Lancers Baseball</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a1929">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #0a1929 0%, #0f2847 50%, #1a365d 100%);
            color: white;
        }

        /* Navbar override */
        .navbar {
            background: rgba(10, 25, 41, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Hero */
        .admin-hero {
            padding: 6rem 5% 3rem;
            text-align: center;
            background: linear-gradient(135deg, rgba(237, 137, 54, 0.1) 0%, rgba(26, 54, 93, 0.2) 100%);
        }

        .admin-hero h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: linear-gradient(90deg, #ed8936, #f6ad55, #ed8936);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .admin-hero p {
            color: #94a3b8;
            font-size: 1.1rem;
        }

        /* Main Section */
        .admin-section {
            max-width: 1400px;
            margin: -2rem auto 2rem;
            padding: 2rem;
        }

        /* Glass Card */
        .glass-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .glass-card h3 {
            color: #ed8936;
            font-size: 1.2rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Access Denied */
        .access-denied {
            text-align: center;
            padding: 4rem 2rem;
        }

        .access-denied .emoji {
            font-size: 5rem;
            margin-bottom: 1rem;
        }

        .access-denied h2 {
            color: #ef4444;
            margin-bottom: 1rem;
        }

        .access-denied p {
            color: #94a3b8;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 1.25rem;
            border-radius: 16px;
            text-align: center;
            border-left: 4px solid;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-card.green { border-color: #22c55e; }
        .stat-card.red { border-color: #ef4444; }
        .stat-card.yellow { border-color: #eab308; }
        .stat-card.blue { border-color: #3b82f6; }
        .stat-card.orange { border-color: #ed8936; }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
        }

        .stat-label {
            color: #94a3b8;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Montserrat', sans-serif;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #ed8936 0%, #f6ad55 100%);
            color: #0a1929;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Event Card */
        .event-card {
            background: rgba(237, 137, 54, 0.1);
            border-left: 4px solid #ed8936;
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .event-card h4 {
            color: white;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .event-card p {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .event-stats {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-badge.present { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .status-badge.absent { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .status-badge.maybe { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .status-badge.pending { background: rgba(148, 163, 184, 0.2); color: #94a3b8; }

        /* Players Table */
        .players-table {
            width: 100%;
            border-collapse: collapse;
        }

        .players-table th,
        .players-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .players-table th {
            background: rgba(237, 137, 54, 0.2);
            color: #ed8936;
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .players-table th:first-child { border-radius: 12px 0 0 0; }
        .players-table th:last-child { border-radius: 0 12px 0 0; }

        .players-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .player-number {
            background: linear-gradient(135deg, #ed8936 0%, #f6ad55 100%);
            color: #0a1929;
            padding: 0.25rem 0.6rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        /* Player Cards Grid */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .player-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: transform 0.3s ease;
        }

        .player-card:hover {
            transform: translateY(-3px);
        }

        .player-card-info {
            flex: 1;
        }

        .player-card-name {
            font-weight: 700;
            color: white;
        }

        .player-card-role {
            color: #64748b;
            font-size: 0.85rem;
        }

        .mini-stats {
            display: flex;
            gap: 0.5rem;
        }

        .mini-stat {
            text-align: center;
            padding: 0.4rem 0.6rem;
            border-radius: 8px;
            min-width: 40px;
        }

        .mini-stat.green { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .mini-stat.red { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .mini-stat.yellow { background: rgba(234, 179, 8, 0.2); color: #eab308; }

        .mini-stat-value {
            font-weight: 700;
            font-size: 1rem;
        }

        .attendance-rate {
            font-size: 1.3rem;
            font-weight: 800;
            padding: 0.5rem;
        }

        .attendance-rate.high { color: #22c55e; }
        .attendance-rate.medium { color: #eab308; }
        .attendance-rate.low { color: #ef4444; }

        /* Presence List */
        .presence-section {
            margin-top: 1.5rem;
        }

        .presence-section h4 {
            color: white;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .presence-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .presence-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 0.75rem 1rem;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-left: 3px solid;
        }

        .presence-item.present { border-color: #22c55e; }
        .presence-item.absent { border-color: #ef4444; }
        .presence-item.maybe { border-color: #eab308; }
        .presence-item.pending { border-color: #64748b; }

        .presence-item .number {
            font-weight: 700;
            color: #ed8936;
        }

        .presence-item .name {
            flex: 1;
            color: white;
            font-size: 0.9rem;
        }

        .presence-item .icon {
            font-size: 1.1rem;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .action-btn {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .action-btn.refresh { background: linear-gradient(135deg, #ed8936 0%, #f6ad55 100%); color: #0a1929; }
        .action-btn.whatsapp { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; }
        .action-btn.email { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }

        /* Event Selector */
        .event-select {
            width: 100%;
            padding: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 1rem;
            font-family: 'Montserrat', sans-serif;
            cursor: pointer;
            margin-bottom: 1rem;
        }

        .event-select:focus {
            outline: none;
            border-color: #ed8936;
        }

        .event-select option {
            background: #0a1929;
            color: white;
        }

        /* Admin Action Buttons */
        .admin-actions {
            display: flex;
            gap: 0.3rem;
        }

        .admin-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.1);
            opacity: 0.5;
        }

        .admin-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .admin-btn.active {
            opacity: 1;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .admin-btn.yes { background: rgba(34, 197, 94, 0.3); }
        .admin-btn.yes:hover, .admin-btn.yes.active { background: rgba(34, 197, 94, 0.6); }
        .admin-btn.maybe { background: rgba(234, 179, 8, 0.3); }
        .admin-btn.maybe:hover, .admin-btn.maybe.active { background: rgba(234, 179, 8, 0.6); }
        .admin-btn.no { background: rgba(239, 68, 68, 0.3); }
        .admin-btn.no:hover, .admin-btn.no.active { background: rgba(239, 68, 68, 0.6); }

        .admin-btn.saving {
            opacity: 0.3;
            pointer-events: none;
        }

        /* Back Button */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            text-decoration: none;
            border-radius: 12px;
            margin-top: 2rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #94a3b8;
        }

        .loading::after {
            content: '‚öæ';
            display: inline-block;
            margin-left: 0.5rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Footer */
        footer {
            background: rgba(0, 0, 0, 0.3);
            padding: 2rem;
            text-align: center;
            color: #64748b;
            margin-top: 2rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-hero h1 { font-size: 1.8rem; }
            .admin-section { padding: 1rem; }
            .players-table th, .players-table td { padding: 0.75rem 0.5rem; font-size: 0.85rem; }
            .action-buttons { flex-direction: column; }
            .action-btn { width: 100%; justify-content: center; }
            .admin-actions { gap: 0.2rem; }
            .admin-btn { width: 28px; height: 28px; font-size: 0.75rem; }
            .presence-list { grid-template-columns: 1fr; }
            .players-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .stat-value { font-size: 1.8rem; }
            .tabs { flex-direction: column; }
            .tab-btn { width: 100%; text-align: center; }
            .glass-card { padding: 1rem; }
            .event-card { padding: 1rem; }
            .event-stats { justify-content: center; }
            .status-badge { padding: 0.3rem 0.6rem; font-size: 0.75rem; }
        }

        @media (max-width: 480px) {
            .admin-hero { padding: 4rem 3% 2rem; }
            .admin-hero h1 { font-size: 1.5rem; }
            .admin-hero p { font-size: 0.9rem; }
            .stats-grid { grid-template-columns: 1fr 1fr; gap: 0.5rem; }
            .stat-card { padding: 0.75rem; }
            .stat-value { font-size: 1.5rem; }
            .stat-label { font-size: 0.7rem; }
            .players-table { font-size: 0.8rem; }
            .players-table th, .players-table td { padding: 0.5rem 0.3rem; }
            .player-number { padding: 0.2rem 0.4rem; font-size: 0.75rem; }
            .admin-btn { width: 26px; height: 26px; font-size: 0.7rem; }
        }
    </style>
</head>
<body>
    <script>
        // Ripristina sessione
        if (localStorage.getItem('authenticated') === 'true') {
            sessionStorage.setItem('authenticated', 'true');
            const savedPlayer = localStorage.getItem('playerData');
            if (savedPlayer) sessionStorage.setItem('playerData', savedPlayer);
        }
        if (sessionStorage.getItem('authenticated') !== 'true') {
            window.location.href = 'login.html';
        }
        
        const playerData = JSON.parse(sessionStorage.getItem('playerData') || '{}');
        const authorizedNumbers = [25, 19, 38, 6, 'ADMIN'];
        
        if (!authorizedNumbers.includes(playerData.number)) {
            document.addEventListener('DOMContentLoaded', function() {
                document.getElementById('mainContent').innerHTML = `
                    <section class="admin-section">
                        <div class="glass-card">
                            <div class="access-denied">
                                <div class="emoji">üö´</div>
                                <h2>Accesso Negato</h2>
                                <p>Non hai i permessi per visualizzare questa pagina.</p>
                                <p style="margin-top: 0.5rem;">Questa area √® riservata allo staff tecnico.</p>
                                <a href="index.html" class="back-btn">‚Üê Torna alla Home</a>
                            </div>
                        </div>
                    </section>
                `;
            });
        }
    </script>

    <nav class="navbar">
        <div class="nav-brand">
            <div class="baseball-ball logo"></div>
            <span class="team-name">Lancers Baseball</span>
        </div>
        <ul class="nav-links">
            <li><a href="index.html">üè† Home</a></li>
            <li><a href="calendario-completo.html">üìÖ Calendario</a></li>
            <li><a href="allenamenti.html">üèãÔ∏è Allenamenti</a></li>
            <li><a href="calendario.html">‚öæ Partite</a></li>
            <li><a href="presenze.html">üìã Presenze</a></li>
            <li><a href="documento.html">üìÑ Documento</a></li>
            <li><a href="gestione-presenze.html" class="active">üìä Gestione</a></li>
            <li><button id="logoutBtn" class="nav-logout-btn">üö™ Logout</button></li>
        </ul>
        <div class="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </nav>

    <div class="admin-hero">
        <h1>üìä Gestione Presenze</h1>
        <p>Riepilogo presenze di tutti i giocatori</p>
    </div>

    <div id="mainContent">
        <section class="admin-section">
            <!-- Stats -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card blue"><div class="stat-value">-</div><div class="stat-label">Risposte Totali</div></div>
                <div class="stat-card green"><div class="stat-value">-</div><div class="stat-label">‚úÖ Presenti</div></div>
                <div class="stat-card yellow"><div class="stat-value">-</div><div class="stat-label">‚ö†Ô∏è Forse</div></div>
                <div class="stat-card red"><div class="stat-value">-</div><div class="stat-label">‚ùå Assenti</div></div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('next')">üéØ Prossimo Evento</button>
                <button class="tab-btn" onclick="showTab('byEvent')">üìÖ Per Evento</button>
                <button class="tab-btn" onclick="showTab('byPlayer')">üë• Per Giocatore</button>
            </div>

            <!-- TAB: Prossimo Evento -->
            <div id="tab-next" class="tab-content active">
                <div class="glass-card">
                    <h3>üéØ Chi sar√† presente al prossimo evento</h3>
                    <div id="nextEventInfo" class="loading">Caricamento</div>
                </div>
            </div>

            <!-- TAB: Per Evento -->
            <div id="tab-byEvent" class="tab-content">
                <div class="glass-card">
                    <h3>üìÖ Seleziona Evento</h3>
                    <select class="event-select" id="eventSelect" onchange="showEventDetails()">
                        <option value="">-- Seleziona un evento --</option>
                    </select>
                    <div id="eventDetails"></div>
                </div>
            </div>

            <!-- TAB: Per Giocatore -->
            <div id="tab-byPlayer" class="tab-content">
                <div class="glass-card">
                    <h3>üë• Statistiche Giocatori</h3>
                    <div id="playerStats" class="loading">Caricamento</div>
                </div>
            </div>

            <!-- Actions -->
            <div class="glass-card">
                <h3>üì§ Azioni Rapide</h3>
                <div class="action-buttons">
                    <button class="action-btn refresh" onclick="loadAllData()">üîÑ Aggiorna Dati</button>
                    <button class="action-btn whatsapp" onclick="sendWhatsApp()">üí¨ Invia su WhatsApp</button>
                    <button class="action-btn email" onclick="sendEmail()">üìß Invia Email</button>
                </div>
            </div>

            <!-- Test Notifiche (solo admin) -->
            <div class="glass-card">
                <h3>üîî Test Notifiche</h3>
                <p style="color: #94a3b8; margin-bottom: 1rem; font-size: 0.9rem;">Invia una notifica di test per verificare che il sistema funzioni.</p>
                <div class="action-buttons">
                    <button class="action-btn" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white;" onclick="testNotificaAdmin()">üß™ Invia Notifica Test</button>
                    <button class="action-btn" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%); color: white;" onclick="mostraStatoNotificheAdmin()">üìä Stato Sistema</button>
                </div>
                <div id="notif-status-admin" style="margin-top: 1rem; padding: 1rem; background: rgba(0, 0, 0, 0.3); border-radius: 10px; font-size: 0.85rem; display: none;"></div>
            </div>

            <div style="text-align: center;">
                <a href="index.html" class="back-btn">‚Üê Torna alla Home</a>
            </div>
        </section>
    </div>

    <footer>
        <p>‚öæ ¬© 2026 Lancers Baseball Club - Serie B</p>
    </footer>

    <script src="script.js?v=43"></script>
    <script>
        // Firebase URL
        const FIREBASE_URL = 'https://lancersareariservata-default-rtdb.europe-west1.firebasedatabase.app';
        const WHATSAPP_NUMBER = '393331549353';
        const STAFF_EMAIL = 'loriscarpulla@gmail.com';

        // Lista giocatori
        const allPlayers = [
            { number: 0, name: 'Niccol√≤', surname: 'Bucci', role: 'UTL' },
            { number: 1, name: 'Alessandro', surname: 'Ferrini', role: 'P/SS' },
            { number: 3, name: 'Ettore', surname: 'Della Nave', role: 'OF/P' },
            { number: 4, name: 'Giovanni G.', surname: 'Beudean', role: 'P/OF' },
            { number: 6, name: 'Simone', surname: 'Geri', role: 'OF' },
            { number: 7, name: 'Silvano', surname: 'Albano', role: 'OF/IF' },
            { number: 8, name: 'Tommaso', surname: 'Panichi', role: 'OF' },
            { number: 12, name: 'Francesco', surname: 'Grassi', role: '1B/DH' },
            { number: 14, name: 'Leonardo', surname: 'Scarpulla', role: 'OF/2B' },
            { number: 19, name: 'Simone', surname: 'Baratella', role: '1B/3B' },
            { number: 22, name: 'Giuseppe G.', surname: 'Grado', role: 'P' },
            { number: 24, name: 'Guido', surname: 'Nannucci', role: 'UTL' },
            { number: 25, name: 'Lorenzo', surname: 'Scarpulla', role: 'DH/C' },
            { number: 32, name: 'Filippo', surname: 'Anichini', role: '3B/SS' },
            { number: 38, name: 'Antonio', surname: 'Parrini', role: 'SS/3B' },
            { number: 59, name: 'Lapo', surname: 'Biondi', role: '2B/SS' },
            { number: 77, name: 'Cosimo', surname: 'Rinaldi', role: '1B/RF' },
            { number: 89, name: 'Daniele', surname: 'Silvestri', role: 'P' },
            { number: 90, name: 'Alessandro', surname: 'Rrethatori', role: 'C' },
            { number: 98, name: 'Francesco', surname: 'Paperini', role: 'UTL' },
            { number: 99, name: 'Victor', surname: 'Vergara', role: 'UTL' }
        ];

        // Usa allEvents dal file script.js (gi√† caricato)

        // Cache presenze
        let presencesCache = {};

        // Formatta data
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const days = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
            const months = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
            return `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]}`;
        }

        function formatDateLong(dateStr) {
            const date = new Date(dateStr);
            const days = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
            const months = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            return `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]}`;
        }

        // Prossimo evento (include mercoled√¨ specifici)
        function getNextEvent() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const allEventsWithWed = getAllEventsWithWednesdays();
            for (const event of allEventsWithWed) {
                const eventDate = new Date(event.date);
                if (eventDate >= today) return event;
            }
            return null;
        }
        
        // Ottieni i giocatori per un evento (tutti o solo assegnati per mercoled√¨)
        function getPlayersForEvent(event) {
            // Se √® un mercoled√¨ specifico, ritorna solo i giocatori assegnati
            if (wednesdayTrainings && wednesdayTrainings[event.date]) {
                const assignedNumbers = wednesdayTrainings[event.date].giocatori;
                return allPlayers.filter(p => assignedNumbers.includes(p.number));
            }
            // Altrimenti tutti i giocatori
            return allPlayers;
        }
        
        // Costruisce lista eventi completa (allEvents + mercoled√¨ specifici)
        function getAllEventsWithWednesdays() {
            const events = [...allEvents];
            
            if (typeof wednesdayTrainings !== 'undefined') {
                for (const [date, info] of Object.entries(wednesdayTrainings)) {
                    events.push({
                        date: date,
                        type: 'wednesday-specific',
                        title: `Mercoled√¨ ${info.tipo}`,
                        time: 'üïê 19:30 - 21:30',
                        tag: 'üéØ Specifico',
                        assignedPlayers: info.giocatori
                    });
                }
            }
            
            events.sort((a, b) => a.date.localeCompare(b.date));
            return events;
        }

        // Carica presenze da Firebase
        async function loadPresences() {
            try {
                const response = await fetch(`${FIREBASE_URL}/presenze.json`);
                const data = await response.json();
                presencesCache = data || {};
                return presencesCache;
            } catch (error) {
                console.error('Errore caricamento presenze:', error);
                return {};
            }
        }

        // Ottieni stato presenza per un giocatore e data
        function getPlayerPresence(playerNumber, eventDate) {
            // dateKey format: 2026_02_03
            const dateKey = eventDate.replace(/-/g, '_');
            
            // playerNumber is stored directly (e.g., "25", not "player_25")
            if (presencesCache[playerNumber] && presencesCache[playerNumber][dateKey]) {
                return presencesCache[playerNumber][dateKey].response;
            }
            return null;
        }

        // Mostra tab
        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // Carica tutti i dati
        async function loadAllData() {
            await loadPresences();
            
            // Calcola statistiche globali
            let totalResponses = 0, totalPresent = 0, totalMaybe = 0, totalAbsent = 0;
            
            Object.values(presencesCache).forEach(playerData => {
                Object.values(playerData).forEach(response => {
                    if (response.response) {
                        totalResponses++;
                        if (response.response === 'yes') totalPresent++;
                        else if (response.response === 'maybe') totalMaybe++;
                        else if (response.response === 'no') totalAbsent++;
                    }
                });
            });

            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card blue"><div class="stat-value">${totalResponses}</div><div class="stat-label">Risposte Totali</div></div>
                <div class="stat-card green"><div class="stat-value">${totalPresent}</div><div class="stat-label">‚úÖ Presenti</div></div>
                <div class="stat-card yellow"><div class="stat-value">${totalMaybe}</div><div class="stat-label">‚ö†Ô∏è Forse</div></div>
                <div class="stat-card red"><div class="stat-value">${totalAbsent}</div><div class="stat-label">‚ùå Assenti</div></div>
            `;

            // Prossimo evento
            loadNextEvent();

            // Popola select eventi (include mercoled√¨ specifici E eventi passati)
            const eventSelect = document.getElementById('eventSelect');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const allEventsWithWed = getAllEventsWithWednesdays();
            
            // Separa eventi futuri e passati
            const futureEvents = [];
            const pastEvents = [];
            
            allEventsWithWed.forEach((event) => {
                const eventDate = new Date(event.date);
                if (eventDate >= today) {
                    futureEvents.push(event);
                } else {
                    pastEvents.push(event);
                }
            });
            
            // Ordina eventi passati dal pi√π recente
            pastEvents.sort((a, b) => b.date.localeCompare(a.date));
            
            eventSelect.innerHTML = '<option value="">-- Seleziona un evento --</option>';
            
            // Prima gli eventi futuri
            if (futureEvents.length > 0) {
                eventSelect.innerHTML += '<optgroup label="üìÖ Eventi Futuri">';
                futureEvents.forEach((event) => {
                    const isWed = event.type === 'wednesday-specific';
                    const label = isWed ? `üéØ ${formatDate(event.date)} - ${event.title}` : `${formatDate(event.date)} - ${event.title}`;
                    eventSelect.innerHTML += `<option value="${event.date}" data-type="${event.type}">${label}</option>`;
                });
                eventSelect.innerHTML += '</optgroup>';
            }
            
            // Poi gli eventi passati
            if (pastEvents.length > 0) {
                eventSelect.innerHTML += '<optgroup label="üìú Eventi Passati">';
                pastEvents.forEach((event) => {
                    const isWed = event.type === 'wednesday-specific';
                    const label = isWed ? `üéØ ${formatDate(event.date)} - ${event.title}` : `${formatDate(event.date)} - ${event.title}`;
                    eventSelect.innerHTML += `<option value="${event.date}" data-type="${event.type}">${label}</option>`;
                });
                eventSelect.innerHTML += '</optgroup>';
            }

            // Statistiche giocatori
            loadPlayerStats();
        }

        // Carica prossimo evento
        function loadNextEvent() {
            const nextEvent = getNextEvent();
            if (!nextEvent) {
                document.getElementById('nextEventInfo').innerHTML = '<p style="color: #94a3b8;">Nessun evento in programma</p>';
                return;
            }

            // Ottieni i giocatori rilevanti per questo evento
            const relevantPlayers = getPlayersForEvent(nextEvent);
            const presentList = [], maybeList = [], absentList = [], pendingList = [];

            relevantPlayers.forEach(player => {
                const status = getPlayerPresence(player.number, nextEvent.date);
                const playerInfo = { ...player, status };
                
                if (status === 'yes') presentList.push(playerInfo);
                else if (status === 'maybe') maybeList.push(playerInfo);
                else if (status === 'no') absentList.push(playerInfo);
                else pendingList.push(playerInfo);
            });
            
            const isWednesday = nextEvent.type === 'wednesday-specific';
            const eventTypeLabel = isWednesday ? 'üéØ Mercoled√¨ Specifico' : '';

            document.getElementById('nextEventInfo').innerHTML = `
                <div class="event-card">
                    <h4>${nextEvent.title}</h4>
                    <p>üìÖ ${formatDateLong(nextEvent.date)} - üïê ${nextEvent.time}</p>
                    ${isWednesday ? `<p style="color: #a78bfa; font-size: 0.9rem; margin-top: 0.5rem;">${eventTypeLabel} - Solo giocatori assegnati (${relevantPlayers.length})</p>` : ''}
                    <div class="event-stats">
                        <span class="status-badge present">‚úÖ ${presentList.length}</span>
                        <span class="status-badge maybe">‚ö†Ô∏è ${maybeList.length}</span>
                        <span class="status-badge absent">‚ùå ${absentList.length}</span>
                        <span class="status-badge pending">‚è≥ ${pendingList.length}</span>
                    </div>
                </div>

                <div class="presence-section">
                    <h4>‚úÖ Presenti (${presentList.length})</h4>
                    <div class="presence-list">
                        ${presentList.map(p => `
                            <div class="presence-item present">
                                <span class="number">#${p.number}</span>
                                <span class="name">${p.name} ${p.surname}</span>
                                <span class="icon">‚úÖ</span>
                            </div>
                        `).join('') || '<p style="color: #64748b; padding: 0.5rem;">Nessuno</p>'}
                    </div>
                </div>

                <div class="presence-section">
                    <h4>‚ö†Ô∏è Forse (${maybeList.length})</h4>
                    <div class="presence-list">
                        ${maybeList.map(p => `
                            <div class="presence-item maybe">
                                <span class="number">#${p.number}</span>
                                <span class="name">${p.name} ${p.surname}</span>
                                <span class="icon">‚ö†Ô∏è</span>
                            </div>
                        `).join('') || '<p style="color: #64748b; padding: 0.5rem;">Nessuno</p>'}
                    </div>
                </div>

                <div class="presence-section">
                    <h4>‚ùå Assenti (${absentList.length})</h4>
                    <div class="presence-list">
                        ${absentList.map(p => `
                            <div class="presence-item absent">
                                <span class="number">#${p.number}</span>
                                <span class="name">${p.name} ${p.surname}</span>
                                <span class="icon">‚ùå</span>
                            </div>
                        `).join('') || '<p style="color: #64748b; padding: 0.5rem;">Nessuno</p>'}
                    </div>
                </div>

                <div class="presence-section">
                    <h4>‚è≥ In attesa di risposta (${pendingList.length})</h4>
                    <div class="presence-list">
                        ${pendingList.map(p => `
                            <div class="presence-item pending">
                                <span class="number">#${p.number}</span>
                                <span class="name">${p.name} ${p.surname}</span>
                                <span class="icon">‚è≥</span>
                            </div>
                        `).join('') || '<p style="color: #64748b; padding: 0.5rem;">Nessuno</p>'}
                    </div>
                </div>
            `;
        }

        // Mostra dettagli evento selezionato
        function showEventDetails() {
            const selectedDate = document.getElementById('eventSelect').value;
            if (!selectedDate) {
                document.getElementById('eventDetails').innerHTML = '';
                return;
            }

            // Trova l'evento dalla lista completa
            const allEventsWithWed = getAllEventsWithWednesdays();
            const event = allEventsWithWed.find(e => e.date === selectedDate);
            if (!event) {
                document.getElementById('eventDetails').innerHTML = '<p style="color: #94a3b8;">Evento non trovato</p>';
                return;
            }
            
            // Ottieni i giocatori rilevanti per questo evento
            const relevantPlayers = getPlayersForEvent(event);
            const presentList = [], maybeList = [], absentList = [], pendingList = [];

            relevantPlayers.forEach(player => {
                const status = getPlayerPresence(player.number, event.date);
                const playerInfo = { ...player, status };
                
                if (status === 'yes') presentList.push(playerInfo);
                else if (status === 'maybe') maybeList.push(playerInfo);
                else if (status === 'no') absentList.push(playerInfo);
                else pendingList.push(playerInfo);
            });
            
            const isWednesday = event.type === 'wednesday-specific';

            document.getElementById('eventDetails').innerHTML = `
                <div class="event-card">
                    <h4>${event.title}</h4>
                    <p>üìÖ ${formatDateLong(event.date)} - üïê ${event.time}</p>
                    ${isWednesday ? `<p style="color: #a78bfa; font-size: 0.9rem; margin-top: 0.5rem;">üéØ Mercoled√¨ Specifico - Solo giocatori assegnati (${relevantPlayers.length})</p>` : ''}
                    <div class="event-stats">
                        <span class="status-badge present">‚úÖ ${presentList.length}</span>
                        <span class="status-badge maybe">‚ö†Ô∏è ${maybeList.length}</span>
                        <span class="status-badge absent">‚ùå ${absentList.length}</span>
                        <span class="status-badge pending">‚è≥ ${pendingList.length}</span>
                    </div>
                </div>

                <table class="players-table">
                    <thead>
                        <tr><th>#</th><th>Giocatore</th><th>Ruolo</th><th>Stato</th><th>Azioni Admin</th></tr>
                    </thead>
                    <tbody>
                        ${[...presentList, ...maybeList, ...absentList, ...pendingList].map(p => `
                            <tr id="row-${p.number}-${event.date.replace(/-/g, '_')}">
                                <td><span class="player-number">${p.number}</span></td>
                                <td>${p.name} ${p.surname}</td>
                                <td>${p.role}</td>
                                <td><span class="status-badge ${p.status === 'yes' ? 'present' : p.status === 'maybe' ? 'maybe' : p.status === 'no' ? 'absent' : 'pending'}" id="status-${p.number}-${event.date.replace(/-/g, '_')}">
                                    ${p.status === 'yes' ? '‚úÖ Presente' : p.status === 'maybe' ? '‚ö†Ô∏è Forse' : p.status === 'no' ? '‚ùå Assente' : '‚è≥ In attesa'}
                                </span></td>
                                <td class="admin-actions">
                                    <button class="admin-btn yes ${p.status === 'yes' ? 'active' : ''}" onclick="setPresenceAdmin(${p.number}, '${event.date}', 'yes')" title="Presente">‚úÖ</button>
                                    <button class="admin-btn maybe ${p.status === 'maybe' ? 'active' : ''}" onclick="setPresenceAdmin(${p.number}, '${event.date}', 'maybe')" title="Forse">‚ö†Ô∏è</button>
                                    <button class="admin-btn no ${p.status === 'no' ? 'active' : ''}" onclick="setPresenceAdmin(${p.number}, '${event.date}', 'no')" title="Assente">‚ùå</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Statistiche giocatori
        function loadPlayerStats() {
            const playerStatsHtml = allPlayers.map(player => {
                let present = 0, maybe = 0, absent = 0;
                
                // Cerca con il numero diretto
                if (presencesCache[player.number]) {
                    Object.values(presencesCache[player.number]).forEach(response => {
                        if (response.response === 'yes') present++;
                        else if (response.response === 'maybe') maybe++;
                        else if (response.response === 'no') absent++;
                    });
                }

                const total = present + maybe + absent;
                const rate = total > 0 ? Math.round((present / total) * 100) : 0;
                const rateClass = rate >= 70 ? 'high' : rate >= 40 ? 'medium' : 'low';

                return `
                    <div class="player-card">
                        <span class="player-number">${player.number}</span>
                        <div class="player-card-info">
                            <div class="player-card-name">${player.name} ${player.surname}</div>
                            <div class="player-card-role">${player.role}</div>
                        </div>
                        <div class="mini-stats">
                            <div class="mini-stat green"><div class="mini-stat-value">${present}</div></div>
                            <div class="mini-stat yellow"><div class="mini-stat-value">${maybe}</div></div>
                            <div class="mini-stat red"><div class="mini-stat-value">${absent}</div></div>
                        </div>
                        <div class="attendance-rate ${rateClass}">${rate}%</div>
                    </div>
                `;
            }).join('');

            document.getElementById('playerStats').innerHTML = `<div class="players-grid">${playerStatsHtml}</div>`;
        }
        
        // ==========================================
        // üîê ADMIN: Imposta presenza per un giocatore
        // ==========================================
        async function setPresenceAdmin(playerNumber, eventDate, response) {
            const dateKey = eventDate.replace(/-/g, '_');
            const rowId = `row-${playerNumber}-${dateKey}`;
            const statusId = `status-${playerNumber}-${dateKey}`;
            
            // Trova i pulsanti e li mette in stato "saving"
            const row = document.getElementById(rowId);
            if (row) {
                row.querySelectorAll('.admin-btn').forEach(btn => btn.classList.add('saving'));
            }
            
            const presenceData = {
                response: response,
                timestamp: new Date().toISOString(),
                setByAdmin: true
            };
            
            try {
                // Salva su Firebase
                const url = `${FIREBASE_URL}/presenze/${playerNumber}/${dateKey}.json`;
                const res = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(presenceData)
                });
                
                if (!res.ok) throw new Error('Errore salvataggio');
                
                // Aggiorna cache locale
                if (!presencesCache[playerNumber]) {
                    presencesCache[playerNumber] = {};
                }
                presencesCache[playerNumber][dateKey] = presenceData;
                
                // Aggiorna UI - stato badge
                const statusBadge = document.getElementById(statusId);
                if (statusBadge) {
                    statusBadge.className = `status-badge ${response === 'yes' ? 'present' : response === 'maybe' ? 'maybe' : 'absent'}`;
                    statusBadge.innerHTML = response === 'yes' ? '‚úÖ Presente' : response === 'maybe' ? '‚ö†Ô∏è Forse' : '‚ùå Assente';
                }
                
                // Aggiorna pulsanti attivi
                if (row) {
                    row.querySelectorAll('.admin-btn').forEach(btn => {
                        btn.classList.remove('saving', 'active');
                        if (btn.classList.contains(response)) {
                            btn.classList.add('active');
                        }
                    });
                }
                
                // Aggiorna contatori nell'event card
                updateEventCounters(eventDate);
                
            } catch (error) {
                console.error('Errore salvataggio presenza admin:', error);
                alert('Errore nel salvataggio. Riprova.');
                
                // Rimuovi stato saving
                if (row) {
                    row.querySelectorAll('.admin-btn').forEach(btn => btn.classList.remove('saving'));
                }
            }
        }
        
        // Aggiorna i contatori nell'event card dopo modifica
        function updateEventCounters(eventDate) {
            const allEventsWithWed = getAllEventsWithWednesdays();
            const event = allEventsWithWed.find(e => e.date === eventDate);
            if (!event) return;
            
            const relevantPlayers = getPlayersForEvent(event);
            let present = 0, maybe = 0, absent = 0, pending = 0;
            
            relevantPlayers.forEach(player => {
                const status = getPlayerPresence(player.number, eventDate);
                if (status === 'yes') present++;
                else if (status === 'maybe') maybe++;
                else if (status === 'no') absent++;
                else pending++;
            });
            
            // Aggiorna i badge nell'event card
            const eventCard = document.querySelector('#eventDetails .event-card');
            if (eventCard) {
                const stats = eventCard.querySelector('.event-stats');
                if (stats) {
                    stats.innerHTML = `
                        <span class="status-badge present">‚úÖ ${present}</span>
                        <span class="status-badge maybe">‚ö†Ô∏è ${maybe}</span>
                        <span class="status-badge absent">‚ùå ${absent}</span>
                        <span class="status-badge pending">‚è≥ ${pending}</span>
                    `;
                }
            }
        }

        // Invia WhatsApp
        function sendWhatsApp() {
            const nextEvent = getNextEvent();
            if (!nextEvent) { alert('Nessun evento in programma'); return; }

            const relevantPlayers = getPlayersForEvent(nextEvent);
            const presentList = [], maybeList = [], absentList = [], pendingList = [];
            relevantPlayers.forEach(player => {
                const status = getPlayerPresence(player.number, nextEvent.date);
                const name = `#${player.number} ${player.name} ${player.surname}`;
                if (status === 'yes') presentList.push(name);
                else if (status === 'maybe') maybeList.push(name);
                else if (status === 'no') absentList.push(name);
                else pendingList.push(name);
            });

            const isWednesday = nextEvent.type === 'wednesday-specific';
            let message = `‚öæ *PRESENZE LANCERS*\n\n`;
            message += `üìÖ *${nextEvent.title}*\nüìÜ ${formatDateLong(nextEvent.date)}\nüïê ${nextEvent.time}\n`;
            if (isWednesday) message += `üéØ _Mercoled√¨ Specifico_\n`;
            message += `\n`;
            message += `‚úÖ *PRESENTI (${presentList.length}):*\n${presentList.join('\n') || '(nessuno)'}\n\n`;
            message += `‚ö†Ô∏è *FORSE (${maybeList.length}):*\n${maybeList.join('\n') || '(nessuno)'}\n\n`;
            message += `‚ùå *ASSENTI (${absentList.length}):*\n${absentList.join('\n') || '(nessuno)'}\n\n`;
            message += `‚è≥ *IN ATTESA (${pendingList.length}):*\n${pendingList.join('\n') || '(nessuno)'}\n\n`;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüë• Disponibili: ${presentList.length + maybeList.length}/${relevantPlayers.length}`;

            window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`, '_blank');
        }

        // Invia Email
        function sendEmail() {
            const nextEvent = getNextEvent();
            if (!nextEvent) { alert('Nessun evento in programma'); return; }

            const relevantPlayers = getPlayersForEvent(nextEvent);
            const presentList = [], maybeList = [], absentList = [], pendingList = [];
            relevantPlayers.forEach(player => {
                const status = getPlayerPresence(player.number, nextEvent.date);
                const name = `#${player.number} ${player.name} ${player.surname}`;
                if (status === 'yes') presentList.push(name);
                else if (status === 'maybe') maybeList.push(name);
                else if (status === 'no') absentList.push(name);
                else pendingList.push(name);
            });

            const isWednesday = nextEvent.type === 'wednesday-specific';
            const subject = `‚öæ Presenze Lancers - ${nextEvent.title} (${formatDate(nextEvent.date)})${isWednesday ? ' - Mercoled√¨ Specifico' : ''}`;
            let body = `RIEPILOGO PRESENZE LANCERS BASEBALL\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            body += `üìÖ Evento: ${nextEvent.title}\nüìÜ Data: ${formatDateLong(nextEvent.date)}\nüïê Orario: ${nextEvent.time}\n`;
            if (isWednesday) body += `üéØ Tipo: Mercoled√¨ Specifico (solo giocatori assegnati)\n`;
            body += `\n`;
            body += `‚úÖ PRESENTI (${presentList.length}):\n${presentList.join('\n') || '(nessuno)'}\n\n`;
            body += `‚ö†Ô∏è FORSE (${maybeList.length}):\n${maybeList.join('\n') || '(nessuno)'}\n\n`;
            body += `‚ùå ASSENTI (${absentList.length}):\n${absentList.join('\n') || '(nessuno)'}\n\n`;
            body += `‚è≥ IN ATTESA (${pendingList.length}):\n${pendingList.join('\n') || '(nessuno)'}\n\n`;
            body += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nTotale disponibili: ${presentList.length + maybeList.length}/${relevantPlayers.length}`;

            window.open(`mailto:${STAFF_EMAIL}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
        }

        // ==========================================
        // üîî TEST NOTIFICHE (solo admin)
        // ==========================================
        
        async function testNotificaAdmin() {
            const statusDiv = document.getElementById('notif-status-admin');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<p>‚è≥ Invio notifica test...</p>';
            
            if (!('Notification' in window)) {
                statusDiv.innerHTML = '<p style="color: #ef4444;">‚ùå Browser non supporta le notifiche</p>';
                return;
            }
            
            if (Notification.permission === 'default') {
                const perm = await Notification.requestPermission();
                if (perm !== 'granted') {
                    statusDiv.innerHTML = '<p style="color: #ef4444;">‚ùå Devi autorizzare le notifiche</p>';
                    return;
                }
            }
            
            if (Notification.permission === 'denied') {
                statusDiv.innerHTML = '<p style="color: #ef4444;">‚ùå Notifiche bloccate. Vai nelle impostazioni del browser.</p>';
                return;
            }
            
            try {
                const registration = await navigator.serviceWorker.ready;
                await registration.showNotification('‚öæ Test Lancers!', {
                    body: '‚úÖ Le notifiche funzionano! Questo √® un test dalla pagina admin.',
                    icon: './icons/icon-192x192.png',
                    badge: './icons/icon-192x192.png',
                    tag: 'admin-test-' + Date.now(),
                    vibrate: [200, 100, 200],
                    requireInteraction: false
                });
                statusDiv.innerHTML = '<p style="color: #22c55e;">‚úÖ Notifica inviata con successo!</p>';
            } catch (e) {
                console.error('Errore notifica:', e);
                statusDiv.innerHTML = '<p style="color: #ef4444;">‚ùå Errore: ' + e.message + '</p>';
            }
        }
        
        async function mostraStatoNotificheAdmin() {
            const statusDiv = document.getElementById('notif-status-admin');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<p>‚è≥ Caricamento stato...</p>';
            
            let html = '<h4 style="margin: 0 0 1rem 0; color: #ed8936;">üìä Stato Sistema Notifiche</h4>';
            
            // Permesso
            const perm = Notification.permission;
            const permIcon = perm === 'granted' ? '‚úÖ' : perm === 'denied' ? '‚ùå' : '‚ö†Ô∏è';
            const permText = perm === 'granted' ? 'Autorizzato' : perm === 'denied' ? 'BLOCCATO' : 'Non richiesto';
            html += `<p><strong>1. Permesso:</strong> ${permIcon} ${permText}</p>`;
            
            // Service Worker
            const swReg = await navigator.serviceWorker.getRegistration();
            const swActive = swReg && swReg.active;
            const swIcon = swActive ? '‚úÖ' : '‚ùå';
            html += `<p><strong>2. Service Worker:</strong> ${swIcon} ${swActive ? 'Attivo' : 'NON ATTIVO'}</p>`;
            
            // Player data
            const playerData = sessionStorage.getItem('playerData');
            const playerIcon = playerData ? '‚úÖ' : '‚ùå';
            html += `<p><strong>3. Login:</strong> ${playerIcon} ${playerData ? 'Loggato' : 'NON LOGGATO'}</p>`;
            
            // Ultimo scheduling
            const lastSchedule = localStorage.getItem('lastNotificationSchedule') || 'Mai';
            html += `<p><strong>4. Ultimo scheduling:</strong> ${lastSchedule}</p>`;
            
            // Riepilogo
            const tuttoOk = perm === 'granted' && swActive && playerData;
            if (tuttoOk) {
                html += `<p style="color: #22c55e; margin-top: 1rem;"><strong>‚úÖ SISTEMA OK!</strong></p>`;
            } else {
                html += `<p style="color: #f59e0b; margin-top: 1rem;"><strong>‚ö†Ô∏è Alcuni componenti non attivi</strong></p>`;
            }
            
            html += `<p style="margin-top: 1rem; opacity: 0.7; font-size: 0.8rem;"><strong>Ora:</strong> ${new Date().toLocaleString('it-IT')}</p>`;
            
            statusDiv.innerHTML = html;
        }

        // Init
        loadAllData();
    </script>
</body>
</html>
