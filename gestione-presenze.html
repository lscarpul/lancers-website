<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Presenze - Lancers Baseball</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a1929">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #0a1929 0%, #0f2847 50%, #1a365d 100%);
            color: white;
        }

        /* Navbar override */
        .navbar {
            background: rgba(10, 25, 41, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Hero */
        .admin-hero {
            padding: 6rem 5% 3rem;
            text-align: center;
            background: linear-gradient(135deg, rgba(237, 137, 54, 0.1) 0%, rgba(26, 54, 93, 0.2) 100%);
        }

        .admin-hero h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: linear-gradient(90deg, #ed8936, #f6ad55, #ed8936);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .admin-hero p {
            color: #94a3b8;
            font-size: 1.1rem;
        }

        /* Main Section */
        .admin-section {
            max-width: 1400px;
            margin: -2rem auto 2rem;
            padding: 2rem;
        }

        /* Glass Card */
        .glass-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .glass-card h3 {
            color: #ed8936;
            font-size: 1.2rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Access Denied */
        .access-denied {
            text-align: center;
            padding: 4rem 2rem;
        }

        .access-denied .emoji {
            font-size: 5rem;
            margin-bottom: 1rem;
        }

        .access-denied h2 {
            color: #ef4444;
            margin-bottom: 1rem;
        }

        .access-denied p {
            color: #94a3b8;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 1.25rem;
            border-radius: 16px;
            text-align: center;
            border-left: 4px solid;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-card.green { border-color: #22c55e; }
        .stat-card.red { border-color: #ef4444; }
        .stat-card.yellow { border-color: #eab308; }
        .stat-card.blue { border-color: #3b82f6; }
        .stat-card.orange { border-color: #ed8936; }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
        }

        .stat-label {
            color: #94a3b8;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Montserrat', sans-serif;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #ed8936 0%, #f6ad55 100%);
            color: #0a1929;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Event Card */
        .event-card {
            background: rgba(237, 137, 54, 0.1);
            border-left: 4px solid #ed8936;
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .event-card h4 {
            color: white;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .event-card p {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .event-stats {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-badge.present { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .status-badge.absent { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .status-badge.maybe { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .status-badge.pending { background: rgba(148, 163, 184, 0.2); color: #94a3b8; }

        /* Players Table */
        .players-table {
            width: 100%;
            border-collapse: collapse;
        }

        .players-table th,
        .players-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .players-table th {
            background: rgba(237, 137, 54, 0.2);
            color: #ed8936;
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .players-table th:first-child { border-radius: 12px 0 0 0; }
        .players-table th:last-child { border-radius: 0 12px 0 0; }

        .players-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .player-number {
            background: linear-gradient(135deg, #ed8936 0%, #f6ad55 100%);
            color: #0a1929;
            padding: 0.25rem 0.6rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        /* Player Cards Grid */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .player-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: transform 0.3s ease;
        }

        .player-card:hover {
            transform: translateY(-3px);
        }

        .player-card-info {
            flex: 1;
        }

        .player-card-name {
            font-weight: 700;
            color: white;
        }

        .player-card-role {
            color: #64748b;
            font-size: 0.85rem;
        }

        .mini-stats {
            display: flex;
            gap: 0.5rem;
        }

        .mini-stat {
            text-align: center;
            padding: 0.4rem 0.6rem;
            border-radius: 8px;
            min-width: 40px;
        }

        .mini-stat.green { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .mini-stat.red { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .mini-stat.yellow { background: rgba(234, 179, 8, 0.2); color: #eab308; }

        .mini-stat-value {
            font-weight: 700;
            font-size: 1rem;
        }

        .attendance-rate {
            font-size: 1.3rem;
            font-weight: 800;
            padding: 0.5rem;
        }

        .attendance-rate.high { color: #22c55e; }
        .attendance-rate.medium { color: #eab308; }
        .attendance-rate.low { color: #ef4444; }

        /* Presence List */
        .presence-section {
            margin-top: 1.5rem;
        }

        .presence-section h4 {
            color: white;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .presence-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .presence-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 0.75rem 1rem;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-left: 3px solid;
        }

        .presence-item.present { border-color: #22c55e; }
        .presence-item.absent { border-color: #ef4444; }
        .presence-item.maybe { border-color: #eab308; }
        .presence-item.pending { border-color: #64748b; }

        .presence-item .number {
            font-weight: 700;
            color: #ed8936;
        }

        .presence-item .name {
            flex: 1;
            color: white;
            font-size: 0.9rem;
        }

        .presence-item .icon {
            font-size: 1.1rem;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .action-btn {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .action-btn.refresh { background: linear-gradient(135deg, #ed8936 0%, #f6ad55 100%); color: #0a1929; }
        .action-btn.whatsapp { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; }
        .action-btn.email { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }

        /* Event Selector */
        .event-select {
            width: 100%;
            padding: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 1rem;
            font-family: 'Montserrat', sans-serif;
            cursor: pointer;
            margin-bottom: 1rem;
        }

        .event-select:focus {
            outline: none;
            border-color: #ed8936;
        }

        .event-select option {
            background: #0a1929;
            color: white;
        }

        /* Back Button */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            text-decoration: none;
            border-radius: 12px;
            margin-top: 2rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #94a3b8;
        }

        .loading::after {
            content: '‚öæ';
            display: inline-block;
            margin-left: 0.5rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Footer */
        footer {
            background: rgba(0, 0, 0, 0.3);
            padding: 2rem;
            text-align: center;
            color: #64748b;
            margin-top: 2rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-hero h1 { font-size: 1.8rem; }
            .admin-section { padding: 1rem; }
            .players-table th, .players-table td { padding: 0.75rem 0.5rem; font-size: 0.85rem; }
            .action-buttons { flex-direction: column; }
            .action-btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <script>
        // Ripristina sessione
        if (localStorage.getItem('authenticated') === 'true') {
            sessionStorage.setItem('authenticated', 'true');
            const savedPlayer = localStorage.getItem('playerData');
            if (savedPlayer) sessionStorage.setItem('playerData', savedPlayer);
        }
        if (sessionStorage.getItem('authenticated') !== 'true') {
            window.location.href = 'login.html';
        }
        
        const playerData = JSON.parse(sessionStorage.getItem('playerData') || '{}');
        const authorizedNumbers = [25, 19, 38, 6, 'ADMIN'];
        
        if (!authorizedNumbers.includes(playerData.number)) {
            document.addEventListener('DOMContentLoaded', function() {
                document.getElementById('mainContent').innerHTML = `
                    <section class="admin-section">
                        <div class="glass-card">
                            <div class="access-denied">
                                <div class="emoji">üö´</div>
                                <h2>Accesso Negato</h2>
                                <p>Non hai i permessi per visualizzare questa pagina.</p>
                                <p style="margin-top: 0.5rem;">Questa area √® riservata allo staff tecnico.</p>
                                <a href="index.html" class="back-btn">‚Üê Torna alla Home</a>
                            </div>
                        </div>
                    </section>
                `;
            });
        }
    </script>

    <nav class="navbar">
        <div class="nav-brand">
            <span class="logo">‚öæ</span>
            <span class="team-name">Lancers Baseball</span>
        </div>
        <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="documento.html">Documento</a></li>
            <li><a href="calendario.html">Partite</a></li>
            <li><a href="allenamenti.html">Allenamenti</a></li>
            <li><a href="presenze.html">Presenze</a></li>
        </ul>
        <div class="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </nav>

    <div class="admin-hero">
        <h1>üìä Gestione Presenze</h1>
        <p>Riepilogo presenze di tutti i giocatori</p>
    </div>

    <div id="mainContent">
        <section class="admin-section">
            <!-- Stats -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card blue"><div class="stat-value">-</div><div class="stat-label">Risposte Totali</div></div>
                <div class="stat-card green"><div class="stat-value">-</div><div class="stat-label">‚úÖ Presenti</div></div>
                <div class="stat-card yellow"><div class="stat-value">-</div><div class="stat-label">‚ö†Ô∏è Forse</div></div>
                <div class="stat-card red"><div class="stat-value">-</div><div class="stat-label">‚ùå Assenti</div></div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('next')">üéØ Prossimo Evento</button>
                <button class="tab-btn" onclick="showTab('byEvent')">üìÖ Per Evento</button>
                <button class="tab-btn" onclick="showTab('byPlayer')">üë• Per Giocatore</button>
            </div>

            <!-- TAB: Prossimo Evento -->
            <div id="tab-next" class="tab-content active">
                <div class="glass-card">
                    <h3>üéØ Chi sar√† presente al prossimo evento</h3>
                    <div id="nextEventInfo" class="loading">Caricamento</div>
                </div>
            </div>

            <!-- TAB: Per Evento -->
            <div id="tab-byEvent" class="tab-content">
                <div class="glass-card">
                    <h3>üìÖ Seleziona Evento</h3>
                    <select class="event-select" id="eventSelect" onchange="showEventDetails()">
                        <option value="">-- Seleziona un evento --</option>
                    </select>
                    <div id="eventDetails"></div>
                </div>
            </div>

            <!-- TAB: Per Giocatore -->
            <div id="tab-byPlayer" class="tab-content">
                <div class="glass-card">
                    <h3>üë• Statistiche Giocatori</h3>
                    <div id="playerStats" class="loading">Caricamento</div>
                </div>
            </div>

            <!-- Actions -->
            <div class="glass-card">
                <h3>üì§ Azioni Rapide</h3>
                <div class="action-buttons">
                    <button class="action-btn refresh" onclick="loadAllData()">üîÑ Aggiorna Dati</button>
                    <button class="action-btn whatsapp" onclick="sendWhatsApp()">üí¨ Invia su WhatsApp</button>
                    <button class="action-btn email" onclick="sendEmail()">üìß Invia Email</button>
                </div>
            </div>

            <div style="text-align: center;">
                <a href="index.html" class="back-btn">‚Üê Torna alla Home</a>
            </div>
        </section>
    </div>

    <footer>
        <p>‚öæ ¬© 2026 Lancers Baseball Club - Serie B</p>
    </footer>

    <script src="script.js?v=36"></script>
    <script>
        // Firebase URL
        const FIREBASE_URL = 'https://lancersareariservata-default-rtdb.europe-west1.firebasedatabase.app';
        const WHATSAPP_NUMBER = '393331549353';
        const STAFF_EMAIL = 'loriscarpulla@gmail.com';

        // Lista giocatori
        const allPlayers = [
            { number: 0, name: 'Niccol√≤', surname: 'Bucci', role: 'UTL' },
            { number: 1, name: 'Alessandro', surname: 'Ferrini', role: 'P/SS' },
            { number: 3, name: 'Ettore', surname: 'Della Nave', role: 'OF/P' },
            { number: 4, name: 'Giovanni G.', surname: 'Beudean', role: 'P/OF' },
            { number: 5, name: 'Marco', surname: 'Mastroianni', role: '2B/3B' },
            { number: 6, name: 'Simone', surname: 'Geri', role: 'OF' },
            { number: 7, name: 'Silvano', surname: 'Albano', role: 'OF/IF' },
            { number: 8, name: 'Tommaso', surname: 'Panichi', role: 'OF' },
            { number: 12, name: 'Francesco', surname: 'Grassi', role: '1B/DH' },
            { number: 14, name: 'Leonardo', surname: 'Scarpulla', role: 'OF/2B' },
            { number: 19, name: 'Simone', surname: 'Baratella', role: '1B/3B' },
            { number: 22, name: 'Giuseppe G.', surname: 'Grado', role: 'P' },
            { number: 24, name: 'Guido', surname: 'Nannucci', role: 'UTL' },
            { number: 25, name: 'Lorenzo', surname: 'Scarpulla', role: 'DH/C' },
            { number: 32, name: 'Filippo', surname: 'Anichini', role: '3B/SS' },
            { number: 38, name: 'Antonio', surname: 'Parrini', role: 'SS/3B' },
            { number: 59, name: 'Lapo', surname: 'Biondi', role: '2B/SS' },
            { number: 77, name: 'Cosimo', surname: 'Rinaldi', role: '1B/RF' },
            { number: 89, name: 'Daniele', surname: 'Silvestri', role: 'P' },
            { number: 90, name: 'Alessandro', surname: 'Rrethatori', role: 'C' },
            { number: 98, name: 'Francesco', surname: 'Paperini', role: 'UTL' },
            { number: 99, name: 'Victor', surname: 'Vergara', role: 'UTL' }
        ];

        // Eventi (dal calendario aggiornato)
        const allEvents = [
            { date: '2026-02-03', type: 'training', title: 'Allenamento', time: '19:30 - 21:30' },
            { date: '2026-02-04', type: 'specific', title: 'Allenamento Specifico', time: 'Sessione tecnica' },
            { date: '2026-02-05', type: 'training', title: 'Allenamento', time: '19:30 - 21:30' },
            { date: '2026-02-07', type: 'tbd', title: 'Allenamento', time: 'Da definire' },
            { date: '2026-02-10', type: 'training', title: 'Allenamento', time: '19:30 - 21:30' },
            { date: '2026-02-11', type: 'specific', title: 'Allenamento Specifico', time: 'Sessione tecnica' },
            { date: '2026-02-12', type: 'training', title: 'Allenamento', time: '19:30 - 21:30' },
            { date: '2026-02-14', type: 'tbd', title: 'Allenamento', time: 'Da definire' },
            { date: '2026-02-17', type: 'training', title: 'Allenamento', time: '19:30 - 21:30' },
            { date: '2026-02-18', type: 'specific', title: 'Allenamento Specifico', time: 'Sessione tecnica' },
            { date: '2026-02-19', type: 'training', title: 'Allenamento', time: '19:30 - 21:30' },
            { date: '2026-02-21', type: 'tbd', title: 'Allenamento', time: 'Da definire' },
            { date: '2026-02-24', type: 'training', title: 'Allenamento', time: '19:30 - 21:30' },
            { date: '2026-02-25', type: 'specific', title: 'Allenamento Specifico', time: 'Sessione tecnica' },
            { date: '2026-02-26', type: 'training', title: 'Allenamento', time: '19:30 - 21:30' },
            { date: '2026-02-28', type: 'tbd', title: 'Allenamento', time: 'Da definire' },
            { date: '2026-03-01', type: 'friendly', title: 'Amichevole Interna', time: 'Domenica' },
            { date: '2026-03-08', type: 'friendly', title: 'vs Lucca/Phoenix/Castenaso', time: 'Domenica' },
            { date: '2026-03-14', type: 'friendly', title: '@ Fortitudo', time: 'Sabato' },
            { date: '2026-03-22', type: 'friendly', title: '@ Fiorentina', time: 'Domenica' },
            { date: '2026-03-29', type: 'friendly', title: 'vs Arezzo', time: 'Domenica' },
            { date: '2026-04-12', type: 'match-home', title: 'vs Health & Performance', time: '11:00' },
            { date: '2026-04-19', type: 'match-away', title: '@ Livorno', time: '11:00' },
            { date: '2026-04-26', type: 'match-home', title: 'vs Longbridge', time: '11:00' },
            { date: '2026-05-03', type: 'match-away', title: '@ Colorno', time: '11:00' },
            { date: '2026-05-10', type: 'match-home', title: 'vs Arezzo', time: '11:00' }
        ];

        // Cache presenze
        let presencesCache = {};

        // Formatta data
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const days = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
            const months = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
            return `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]}`;
        }

        function formatDateLong(dateStr) {
            const date = new Date(dateStr);
            const days = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
            const months = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            return `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]}`;
        }

        // Prossimo evento
        function getNextEvent() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            for (const event of allEvents) {
                const eventDate = new Date(event.date);
                if (eventDate >= today) return event;
            }
            return null;
        }

        // Carica presenze da Firebase
        async function loadPresences() {
            try {
                const response = await fetch(`${FIREBASE_URL}/presenze.json`);
                const data = await response.json();
                presencesCache = data || {};
                return presencesCache;
            } catch (error) {
                console.error('Errore caricamento presenze:', error);
                return {};
            }
        }

        // Ottieni stato presenza per un giocatore e data
        function getPlayerPresence(playerNumber, eventDate) {
            // dateKey format: 2026_02_03
            const dateKey = eventDate.replace(/-/g, '_');
            
            // playerNumber is stored directly (e.g., "25", not "player_25")
            if (presencesCache[playerNumber] && presencesCache[playerNumber][dateKey]) {
                return presencesCache[playerNumber][dateKey].response;
            }
            return null;
        }

        // Mostra tab
        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // Carica tutti i dati
        async function loadAllData() {
            await loadPresences();
            
            // Calcola statistiche globali
            let totalResponses = 0, totalPresent = 0, totalMaybe = 0, totalAbsent = 0;
            
            Object.values(presencesCache).forEach(playerData => {
                Object.values(playerData).forEach(response => {
                    if (response.response) {
                        totalResponses++;
                        if (response.response === 'yes') totalPresent++;
                        else if (response.response === 'maybe') totalMaybe++;
                        else if (response.response === 'no') totalAbsent++;
                    }
                });
            });

            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card blue"><div class="stat-value">${totalResponses}</div><div class="stat-label">Risposte Totali</div></div>
                <div class="stat-card green"><div class="stat-value">${totalPresent}</div><div class="stat-label">‚úÖ Presenti</div></div>
                <div class="stat-card yellow"><div class="stat-value">${totalMaybe}</div><div class="stat-label">‚ö†Ô∏è Forse</div></div>
                <div class="stat-card red"><div class="stat-value">${totalAbsent}</div><div class="stat-label">‚ùå Assenti</div></div>
            `;

            // Prossimo evento
            loadNextEvent();

            // Popola select eventi
            const eventSelect = document.getElementById('eventSelect');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            eventSelect.innerHTML = '<option value="">-- Seleziona un evento --</option>';
            allEvents.forEach((event, index) => {
                const eventDate = new Date(event.date);
                if (eventDate >= today) {
                    eventSelect.innerHTML += `<option value="${index}">${formatDate(event.date)} - ${event.title}</option>`;
                }
            });

            // Statistiche giocatori
            loadPlayerStats();
        }

        // Carica prossimo evento
        function loadNextEvent() {
            const nextEvent = getNextEvent();
            if (!nextEvent) {
                document.getElementById('nextEventInfo').innerHTML = '<p style="color: #94a3b8;">Nessun evento in programma</p>';
                return;
            }

            const presentList = [], maybeList = [], absentList = [], pendingList = [];

            allPlayers.forEach(player => {
                const status = getPlayerPresence(player.number, nextEvent.date);
                const playerInfo = { ...player, status };
                
                if (status === 'yes') presentList.push(playerInfo);
                else if (status === 'maybe') maybeList.push(playerInfo);
                else if (status === 'no') absentList.push(playerInfo);
                else pendingList.push(playerInfo);
            });

            document.getElementById('nextEventInfo').innerHTML = `
                <div class="event-card">
                    <h4>${nextEvent.title}</h4>
                    <p>üìÖ ${formatDateLong(nextEvent.date)} - üïê ${nextEvent.time}</p>
                    <div class="event-stats">
                        <span class="status-badge present">‚úÖ ${presentList.length}</span>
                        <span class="status-badge maybe">‚ö†Ô∏è ${maybeList.length}</span>
                        <span class="status-badge absent">‚ùå ${absentList.length}</span>
                        <span class="status-badge pending">‚è≥ ${pendingList.length}</span>
                    </div>
                </div>

                <div class="presence-section">
                    <h4>‚úÖ Presenti (${presentList.length})</h4>
                    <div class="presence-list">
                        ${presentList.map(p => `
                            <div class="presence-item present">
                                <span class="number">#${p.number}</span>
                                <span class="name">${p.name} ${p.surname}</span>
                                <span class="icon">‚úÖ</span>
                            </div>
                        `).join('') || '<p style="color: #64748b; padding: 0.5rem;">Nessuno</p>'}
                    </div>
                </div>

                <div class="presence-section">
                    <h4>‚ö†Ô∏è Forse (${maybeList.length})</h4>
                    <div class="presence-list">
                        ${maybeList.map(p => `
                            <div class="presence-item maybe">
                                <span class="number">#${p.number}</span>
                                <span class="name">${p.name} ${p.surname}</span>
                                <span class="icon">‚ö†Ô∏è</span>
                            </div>
                        `).join('') || '<p style="color: #64748b; padding: 0.5rem;">Nessuno</p>'}
                    </div>
                </div>

                <div class="presence-section">
                    <h4>‚ùå Assenti (${absentList.length})</h4>
                    <div class="presence-list">
                        ${absentList.map(p => `
                            <div class="presence-item absent">
                                <span class="number">#${p.number}</span>
                                <span class="name">${p.name} ${p.surname}</span>
                                <span class="icon">‚ùå</span>
                            </div>
                        `).join('') || '<p style="color: #64748b; padding: 0.5rem;">Nessuno</p>'}
                    </div>
                </div>

                <div class="presence-section">
                    <h4>‚è≥ In attesa di risposta (${pendingList.length})</h4>
                    <div class="presence-list">
                        ${pendingList.map(p => `
                            <div class="presence-item pending">
                                <span class="number">#${p.number}</span>
                                <span class="name">${p.name} ${p.surname}</span>
                                <span class="icon">‚è≥</span>
                            </div>
                        `).join('') || '<p style="color: #64748b; padding: 0.5rem;">Nessuno</p>'}
                    </div>
                </div>
            `;
        }

        // Mostra dettagli evento selezionato
        function showEventDetails() {
            const eventIndex = document.getElementById('eventSelect').value;
            if (!eventIndex) {
                document.getElementById('eventDetails').innerHTML = '';
                return;
            }

            const event = allEvents[eventIndex];
            const presentList = [], maybeList = [], absentList = [], pendingList = [];

            allPlayers.forEach(player => {
                const status = getPlayerPresence(player.number, event.date);
                const playerInfo = { ...player, status };
                
                if (status === 'yes') presentList.push(playerInfo);
                else if (status === 'maybe') maybeList.push(playerInfo);
                else if (status === 'no') absentList.push(playerInfo);
                else pendingList.push(playerInfo);
            });

            document.getElementById('eventDetails').innerHTML = `
                <div class="event-card">
                    <h4>${event.title}</h4>
                    <p>üìÖ ${formatDateLong(event.date)} - üïê ${event.time}</p>
                    <div class="event-stats">
                        <span class="status-badge present">‚úÖ ${presentList.length}</span>
                        <span class="status-badge maybe">‚ö†Ô∏è ${maybeList.length}</span>
                        <span class="status-badge absent">‚ùå ${absentList.length}</span>
                        <span class="status-badge pending">‚è≥ ${pendingList.length}</span>
                    </div>
                </div>

                <table class="players-table">
                    <thead>
                        <tr><th>#</th><th>Giocatore</th><th>Ruolo</th><th>Stato</th></tr>
                    </thead>
                    <tbody>
                        ${[...presentList, ...maybeList, ...absentList, ...pendingList].map(p => `
                            <tr>
                                <td><span class="player-number">${p.number}</span></td>
                                <td>${p.name} ${p.surname}</td>
                                <td>${p.role}</td>
                                <td><span class="status-badge ${p.status === 'yes' ? 'present' : p.status === 'maybe' ? 'maybe' : p.status === 'no' ? 'absent' : 'pending'}">
                                    ${p.status === 'yes' ? '‚úÖ Presente' : p.status === 'maybe' ? '‚ö†Ô∏è Forse' : p.status === 'no' ? '‚ùå Assente' : '‚è≥ In attesa'}
                                </span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Statistiche giocatori
        function loadPlayerStats() {
            const playerStatsHtml = allPlayers.map(player => {
                let present = 0, maybe = 0, absent = 0;
                
                const playerKey = `player_${player.number}`;
                if (presencesCache[playerKey]) {
                    Object.values(presencesCache[playerKey]).forEach(response => {
                        if (response.response === 'yes') present++;
                        else if (response.response === 'maybe') maybe++;
                        else if (response.response === 'no') absent++;
                    });
                }

                const total = present + maybe + absent;
                const rate = total > 0 ? Math.round((present / total) * 100) : 0;
                const rateClass = rate >= 70 ? 'high' : rate >= 40 ? 'medium' : 'low';

                return `
                    <div class="player-card">
                        <span class="player-number">${player.number}</span>
                        <div class="player-card-info">
                            <div class="player-card-name">${player.name} ${player.surname}</div>
                            <div class="player-card-role">${player.role}</div>
                        </div>
                        <div class="mini-stats">
                            <div class="mini-stat green"><div class="mini-stat-value">${present}</div></div>
                            <div class="mini-stat yellow"><div class="mini-stat-value">${maybe}</div></div>
                            <div class="mini-stat red"><div class="mini-stat-value">${absent}</div></div>
                        </div>
                        <div class="attendance-rate ${rateClass}">${rate}%</div>
                    </div>
                `;
            }).join('');

            document.getElementById('playerStats').innerHTML = `<div class="players-grid">${playerStatsHtml}</div>`;
        }

        // Invia WhatsApp
        function sendWhatsApp() {
            const nextEvent = getNextEvent();
            if (!nextEvent) { alert('Nessun evento in programma'); return; }

            const presentList = [], maybeList = [], absentList = [], pendingList = [];
            allPlayers.forEach(player => {
                const status = getPlayerPresence(player.number, nextEvent.date);
                const name = `#${player.number} ${player.name} ${player.surname}`;
                if (status === 'yes') presentList.push(name);
                else if (status === 'maybe') maybeList.push(name);
                else if (status === 'no') absentList.push(name);
                else pendingList.push(name);
            });

            let message = `‚öæ *PRESENZE LANCERS*\n\n`;
            message += `üìÖ *${nextEvent.title}*\nüìÜ ${formatDateLong(nextEvent.date)}\nüïê ${nextEvent.time}\n\n`;
            message += `‚úÖ *PRESENTI (${presentList.length}):*\n${presentList.join('\n') || '(nessuno)'}\n\n`;
            message += `‚ö†Ô∏è *FORSE (${maybeList.length}):*\n${maybeList.join('\n') || '(nessuno)'}\n\n`;
            message += `‚ùå *ASSENTI (${absentList.length}):*\n${absentList.join('\n') || '(nessuno)'}\n\n`;
            message += `‚è≥ *IN ATTESA (${pendingList.length}):*\n${pendingList.join('\n') || '(nessuno)'}\n\n`;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüë• Disponibili: ${presentList.length + maybeList.length}/${allPlayers.length}`;

            window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`, '_blank');
        }

        // Invia Email
        function sendEmail() {
            const nextEvent = getNextEvent();
            if (!nextEvent) { alert('Nessun evento in programma'); return; }

            const presentList = [], maybeList = [], absentList = [], pendingList = [];
            allPlayers.forEach(player => {
                const status = getPlayerPresence(player.number, nextEvent.date);
                const name = `#${player.number} ${player.name} ${player.surname}`;
                if (status === 'yes') presentList.push(name);
                else if (status === 'maybe') maybeList.push(name);
                else if (status === 'no') absentList.push(name);
                else pendingList.push(name);
            });

            const subject = `‚öæ Presenze Lancers - ${nextEvent.title} (${formatDate(nextEvent.date)})`;
            let body = `RIEPILOGO PRESENZE LANCERS BASEBALL\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            body += `üìÖ Evento: ${nextEvent.title}\nüìÜ Data: ${formatDateLong(nextEvent.date)}\nüïê Orario: ${nextEvent.time}\n\n`;
            body += `‚úÖ PRESENTI (${presentList.length}):\n${presentList.join('\n') || '(nessuno)'}\n\n`;
            body += `‚ö†Ô∏è FORSE (${maybeList.length}):\n${maybeList.join('\n') || '(nessuno)'}\n\n`;
            body += `‚ùå ASSENTI (${absentList.length}):\n${absentList.join('\n') || '(nessuno)'}\n\n`;
            body += `‚è≥ IN ATTESA (${pendingList.length}):\n${pendingList.join('\n') || '(nessuno)'}\n\n`;
            body += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nTotale disponibili: ${presentList.length + maybeList.length}/${allPlayers.length}`;

            window.open(`mailto:${STAFF_EMAIL}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
        }

        // Init
        loadAllData();
    </script>
</body>
</html>
