<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conferma Presenza - Lancers Baseball</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1a365d">
<link rel="apple-touch-icon" href="icons/icon-192x192.png"> <meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        .presence-hero {
            min-height: 25vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 50%, #1a365d 100%);
            background-size: 200% 200%;
            animation: gradientShift 8s ease infinite;
            padding: 2rem 5%;
            text-align: center;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .presence-hero h1 {
            color: white;
            font-size: 2.2rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .presence-hero p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        .presence-section {
            max-width: 900px;
            margin: -2rem auto 2rem;
            padding: 2rem;
            background: rgba(15, 40, 71, 0.9);
            border-radius: 24px;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(59, 130, 246, 0.2);
            backdrop-filter: blur(10px);
        }

        .player-info {
            text-align: center;
            margin-bottom: 1.5rem;
            padding: 1.25rem;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.1) 100%);
            border-radius: 16px;
            border: 2px solid rgba(59, 130, 246, 0.3);
        }

        .player-info h3 {
            color: #ffffff;
            margin: 0;
            font-size: 1.3rem;
        }

        .player-info p {
            color: #94a3b8;
            margin: 0.25rem 0 0;
            font-size: 0.9rem;
        }

        .presence-intro {
            text-align: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
        }

        .presence-intro h2 {
            color: #ffffff;
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }

        .presence-intro p {
            color: #94a3b8;
            font-size: 0.95rem;
        }

        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .event-card {
            background: rgba(10, 22, 40, 0.8);
            border-radius: 16px;
            padding: 1.25rem;
            border: 2px solid rgba(59, 130, 246, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .event-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: #3b82f6;
            transition: all 0.3s ease;
        }

        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            border-color: rgba(59, 130, 246, 0.4);
        }

        .event-card.responded-yes {
            border-color: rgba(34, 197, 94, 0.5);
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(34, 197, 94, 0.1) 100%);
        }
        .event-card.responded-yes::before { background: #22c55e; }

        .event-card.responded-no {
            border-color: rgba(220, 38, 38, 0.5);
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.2) 0%, rgba(220, 38, 38, 0.1) 100%);
        }
        .event-card.responded-no::before { background: #dc2626; }

        .event-card.responded-maybe {
            border-color: rgba(234, 179, 8, 0.5);
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.2) 0%, rgba(234, 179, 8, 0.1) 100%);
        }
        .event-card.responded-maybe::before { background: #eab308; }

        .event-card.not-responded {
            border-color: rgba(249, 115, 22, 0.5);
        }
        .event-card.not-responded::before { background: #f97316; }

        .event-card.auto-absent {
            border-color: rgba(220, 38, 38, 0.5);
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.15) 0%, rgba(220, 38, 38, 0.05) 100%);
            opacity: 0.8;
        }
        .event-card.auto-absent::before { background: #991b1b; }

        .event-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .event-type {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .event-type.training {
            background: rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }

        .event-type.match {
            background: rgba(220, 38, 38, 0.3);
            color: #f87171;
        }

        .event-type.friendly {
            background: rgba(249, 115, 22, 0.3);
            color: #fb923c;
        }

        .event-status {
            padding: 0.3rem 0.7rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .event-status.yes {
            background: #48bb78;
            color: white;
        }

        .event-status.no {
            background: #e53e3e;
            color: white;
        }

        .event-status.maybe {
            background: #ecc94b;
            color: #744210;
        }

        .event-status.pending {
            background: #ed8936;
            color: white;
            animation: pulse 2s infinite;
        }

        .event-status.auto-absent {
            background: #c53030;
            color: white;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .event-card-title {
            font-size: 1.05rem;
            color: #1a365d;
            margin: 0 0 0.5rem 0;
            font-weight: 700;
        }

        .event-card-date {
            color: #2d3748;
            font-size: 0.9rem;
            margin: 0.25rem 0;
            font-weight: 600;
        }

        .event-card-time {
            color: #718096;
            font-size: 0.85rem;
            margin: 0.25rem 0;
        }

        .event-card-buttons {
            display: flex;
            gap: 0.6rem;
            margin-top: 1rem;
            justify-content: center;
        }

        .mini-btn {
            width: 55px;
            height: 55px;
            border: none;
            border-radius: 14px;
            font-size: 1.4rem;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .mini-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .mini-btn.yes {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .mini-btn.yes:hover:not(:disabled) {
            transform: scale(1.15) rotate(-5deg);
            box-shadow: 0 8px 20px rgba(72, 187, 120, 0.5);
        }

        .mini-btn.no {
            background: linear-gradient(135deg, #fc8181 0%, #e53e3e 100%);
            color: white;
        }

        .mini-btn.no:hover:not(:disabled) {
            transform: scale(1.15) rotate(5deg);
            box-shadow: 0 8px 20px rgba(229, 62, 62, 0.5);
        }

        .mini-btn.maybe {
            background: linear-gradient(135deg, #ecc94b 0%, #d69e2e 100%);
            color: white;
        }

        .mini-btn.maybe:hover:not(:disabled) {
            transform: scale(1.15);
            box-shadow: 0 8px 20px rgba(214, 158, 46, 0.5);
        }

        .mini-btn.remove {
            background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
            color: white;
            width: 45px;
            height: 45px;
            font-size: 1.1rem;
        }

        .mini-btn.remove:hover:not(:disabled) {
            transform: scale(1.15);
            box-shadow: 0 8px 20px rgba(113, 128, 150, 0.5);
        }

        .no-event {
            text-align: center;
            padding: 3rem;
            color: #718096;
        }

        .no-event .emoji {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.85rem 1.75rem;
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
            color: white;
            text-decoration: none;
            border-radius: 12px;
            margin-top: 1.5rem;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(26, 54, 93, 0.3);
        }

        .back-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(26, 54, 93, 0.4);
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #4a5568;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.yes { background: #48bb78; }
        .legend-dot.no { background: #e53e3e; }
        .legend-dot.maybe { background: #ecc94b; }
        .legend-dot.pending { background: #ed8936; }

        @media (max-width: 768px) {
            .presence-section {
                margin: -1rem 1rem 2rem;
                padding: 1.25rem;
            }
            
            .presence-hero h1 {
                font-size: 1.8rem;
            }
            
            .events-grid {
                grid-template-columns: 1fr;
            }
            
            .mini-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .legend {
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <script>
        if (sessionStorage.getItem('authenticated') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>
    <nav class="navbar">
        <button id="logoutBtn" class="back-btn" style="background: #ef4444; color: white; float: right; margin: 1rem 2rem 0 0;">Logout</button>
        <div class="nav-brand">
            <span class="logo">‚öæ</span>
            <span class="team-name">Lancers Baseball</span>
        </div>
        <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="documento.html">Documento</a></li>
            <li><a href="calendario.html">Partite</a></li>
            <li><a href="allenamenti.html">Allenamenti</a></li>
            <li><a href="presenze.html" class="active">Presenze</a></li>
        </ul>
        <div class="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </nav>

    <div class="presence-hero">
        <div class="hero-content">
            <h1>üìã Conferma Presenza</h1>
            <p>Indica la tua presenza per i prossimi 10 eventi</p>
        </div>
    </div>

    <section class="presence-section" id="presenceSection">
        <!-- Contenuto generato dinamicamente -->
    </section>

    <footer>
        <p>‚öæ ¬© 2026 Lancers Baseball Club - Serie B Federazione Italiana Baseball Softball</p>
        <p class="footer-motto">"Play Hard, Play Fair, Play Together" üèÜ</p>
    </footer>

    <script src="script.js?v=14"></script>
    <script src="firebase-config.js"></script>
    <script>
        // Database eventi per la pagina presenze
        const presenzeEvents = [
            // GENNAIO 2026
            { date: '2026-01-15', type: 'training', title: 'Allenamento', time: '19:30 - 21:30', tag: 'Allenamento' },
            { date: '2026-01-20', type: 'training', title: 'Allenamento', time: '19:30 - 21:30', tag: 'Allenamento' },
            { date: '2026-01-22', type: 'training', title: 'Allenamento', time: '19:30 - 21:30', tag: 'Allenamento' },
            { date: '2026-01-27', type: 'training', title: 'Allenamento', time: '19:30 - 21:30', tag: 'Allenamento' },
            { date: '2026-01-29', type: 'training', title: 'Allenamento', time: '19:30 - 21:30', tag: 'Allenamento' },
            
            // FEBBRAIO 2026
            { date: '2026-02-03', type: 'training', title: 'Allenamento', time: '19:30 - 21:30', tag: 'Allenamento' },
            { date: '2026-02-04', type: 'specific', title: 'Allenamento Specifico', time: 'Sessione tecnica', tag: 'Specifico' },
            { date: '2026-02-05', type: 'training', title: 'Allenamento', time: '19:30 - 21:30', tag: 'Allenamento' },
            { date: '2026-02-10', type: 'training', title: 'Allenamento', time: '19:30 - 21:30', tag: 'Allenamento' },
            { date: '2026-02-11', type: 'specific', title: 'Allenamento Specifico', time: 'Sessione tecnica', tag: 'Specifico' },
            { date: '2026-02-12', type: 'training', title: 'Allenamento', time: '19:30 - 21:30', tag: 'Allenamento' },
            { date: '2026-02-17', type: 'training', title: 'Allenamento', time: '19:30 - 21:30', tag: 'Allenamento' },
            { date: '2026-02-18', type: 'specific', title: 'Allenamento Specifico', time: 'Sessione tecnica', tag: 'Specifico' },
            { date: '2026-02-19', type: 'training', title: 'Allenamento', time: '19:30 - 21:30', tag: 'Allenamento' },
            { date: '2026-02-24', type: 'training', title: 'Allenamento', time: '19:30 - 21:30', tag: 'Allenamento' },
            { date: '2026-02-25', type: 'specific', title: 'Allenamento Specifico', time: 'Sessione tecnica', tag: 'Specifico' },
            { date: '2026-02-26', type: 'training', title: 'Allenamento', time: '19:30 - 21:30', tag: 'Allenamento' },
            
            // MARZO 2026
            { date: '2026-03-01', type: 'friendly', title: 'Amichevole Interna', time: 'Domenica', tag: 'Amichevole' },
            { date: '2026-03-03', type: 'training', title: 'Allenamento', time: '19:30 - 21:30', tag: 'Allenamento' },
            { date: '2026-03-08', type: 'friendly', title: 'vs Lucca/Phoenix/Castenaso', time: 'Domenica', tag: 'Amichevole' },
            { date: '2026-03-14', type: 'friendly', title: '@ Fortitudo', time: 'Sabato', tag: 'Trasferta' },
            { date: '2026-03-22', type: 'friendly', title: '@ Fiorentina', time: 'Domenica', tag: 'Amichevole' },
            { date: '2026-03-29', type: 'friendly', title: 'vs Arezzo', time: 'Domenica', tag: 'Amichevole' },
            
            // APRILE 2026 - Campionato
            { date: '2026-04-12', type: 'match-home', title: 'vs Health & Performance S.S.D', time: '11:00', tag: 'Campionato Casa' },
            { date: '2026-04-19', type: 'match-away', title: '@ Livorno 1940 Baseball', time: '11:00', tag: 'Campionato Trasferta' },
            { date: '2026-04-26', type: 'match-home', title: 'vs Longbridge 2000 B.C', time: '11:00', tag: 'Campionato Casa' },
            
            // MAGGIO 2026
            { date: '2026-05-03', type: 'match-away', title: '@ Colorno B.C.', time: '11:00', tag: 'Campionato Trasferta' },
            { date: '2026-05-10', type: 'match-home', title: 'vs A.S.D BSC Arezzo', time: '11:00', tag: 'Campionato Casa' },
            { date: '2026-05-17', type: 'match-home', title: 'vs Cali Roma XII', time: '11:00', tag: 'Campionato Casa' },
            { date: '2026-05-30', type: 'match-away', title: '@ Padule Baseball A.S.D', time: '15:00', tag: 'Campionato Trasferta' },
            
            // GIUGNO 2026
            { date: '2026-06-07', type: 'match-away', title: '@ Health & Performance S.S.D', time: '11:00', tag: 'Campionato Trasferta' },
            { date: '2026-06-14', type: 'match-home', title: 'vs Livorno 1940 Baseball', time: '11:00', tag: 'Campionato Casa' },
            { date: '2026-06-21', type: 'match-away', title: '@ Longbridge 2000 B.C', time: '11:00', tag: 'Campionato Trasferta' },
            { date: '2026-06-28', type: 'match-home', title: 'vs Colorno B.C.', time: '11:00', tag: 'Campionato Casa' },
            
            // LUGLIO 2026
            { date: '2026-07-05', type: 'match-away', title: '@ A.S.D BSC Arezzo', time: '11:00', tag: 'Campionato Trasferta' },
            { date: '2026-07-12', type: 'match-away', title: '@ Cali Roma XII', time: '11:00', tag: 'Campionato Trasferta' },
            { date: '2026-07-26', type: 'match-home', title: 'vs Padule Baseball A.S.D', time: '11:00', tag: 'Campionato Casa' },
        ];

        // Funzione per ottenere il prossimo evento
        function getNextEvent() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (const event of presenzeEvents) {
                const eventDate = new Date(event.date);
                if (eventDate >= today) {
                    return { ...event, dateObj: eventDate };
                }
            }
            return null;
        }

        // Funzione per ottenere i prossimi N eventi
        function getNextEvents(count = 10) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const futureEvents = [];
            for (const event of presenzeEvents) {
                const eventDate = new Date(event.date);
                if (eventDate >= today) {
                    futureEvents.push({ ...event, dateObj: eventDate });
                    if (futureEvents.length >= count) break;
                }
            }
            return futureEvents;
        }

        // Funzione per formattare la data
        function formatDate(date) {
            const days = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
            const months = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            
            return `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        // Funzione per ottenere la classe del tipo evento
        function getEventTypeClass(type) {
            if (type.includes('match')) return 'match';
            if (type === 'friendly') return 'friendly';
            return 'training';
        }

        // Ottieni le risposte salvate da Firebase
        async function getSavedResponses() {
            const playerData = JSON.parse(sessionStorage.getItem('playerData'));
            if (!playerData) return {};
            
            try {
                const responses = await LancersDB.getPlayer(playerData.number);
                console.log('üì• Risposte caricate:', responses);
                return responses || {};
            } catch (error) {
                console.error('‚ùå Errore caricamento risposte:', error);
                return {};
            }
        }

        // Genera il contenuto della pagina
        async function generateContent() {
            const container = document.getElementById('presenceSection');
            const playerData = sessionStorage.getItem('playerData');
            const nextEvents = getNextEvents(10);
            
            console.log('üöÄ generateContent avviato');
            console.log('üë§ playerData:', playerData);
            console.log('üìÖ nextEvents:', nextEvents.length, 'eventi trovati');
            
            if (!playerData) {
                container.innerHTML = `
                    <div class="no-event">
                        <div class="emoji">üîí</div>
                        <h2>Accesso richiesto</h2>
                        <p>Devi effettuare il login per confermare la presenza</p>
                        <a href="login.html" class="back-btn">üîí Vai al Login</a>
                    </div>
                `;
                return;
            }
            
            const player = JSON.parse(playerData);
            
            // Mostra loading
            container.innerHTML = `
                <div class="player-info">
                    <h3>#${player.number} ${player.name} ${player.surname}</h3>
                    <p>${player.role}</p>
                </div>
                <div style="text-align: center; padding: 2rem;">
                    <p>‚è≥ Caricamento presenze...</p>
                </div>
            `;
            
            let savedResponses = {};
            try {
                savedResponses = await getSavedResponses();
            } catch (error) {
                console.error('‚ùå Errore getSavedResponses:', error);
            }
            
            console.log('üíæ savedResponses:', savedResponses);
            
            // Controlla eventi passati senza risposta e segna come assente automaticamente
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Marca automaticamente come assente gli eventi passati senza risposta
            for (const event of presenzeEvents) {
                const eventDate = new Date(event.date);
                const dayAfterEvent = new Date(eventDate);
                dayAfterEvent.setDate(dayAfterEvent.getDate() + 1);
                
                // Se siamo al giorno dopo l'evento e non c'√® risposta
                if (today >= dayAfterEvent && !savedResponses[event.date]) {
                    try {
                        await LancersDB.save(player.number, event.date, 'no');
                        savedResponses[event.date] = { response: 'no', autoAbsent: true };
                        console.log(`üö´ Auto-assente per evento ${event.date}`);
                    } catch (error) {
                        console.error('Errore auto-assente:', error);
                    }
                }
            }
            
            if (nextEvents.length === 0) {
                container.innerHTML = `
                    <div class="player-info">
                        <h3>#${player.number} ${player.name} ${player.surname}</h3>
                        <p>${player.role}</p>
                    </div>
                    <div class="no-event">
                        <div class="emoji">üìÖ</div>
                        <h2>Nessun evento in programma</h2>
                        <p>Non ci sono eventi futuri nel calendario</p>
                        <a href="index.html" class="back-btn">‚Üê Torna alla Home</a>
                    </div>
                `;
                return;
            }
            
            // Genera le card per ogni evento
            let eventsHTML = nextEvents.map((event, index) => {
                const alreadyResponded = savedResponses[event.date];
                let statusHTML = '';
                let statusClass = '';
                let buttonsDisabled = false;
                
                // Controlla se l'evento √® oggi
                const isToday = event.dateObj.toDateString() === today.toDateString();
                const isTomorrow = new Date(today.getTime() + 86400000).toDateString() === event.dateObj.toDateString();
                
                if (alreadyResponded) {
                    switch(alreadyResponded.response) {
                        case 'yes':
                            statusHTML = '<span class="event-status yes">‚úÖ PRESENTE</span>';
                            statusClass = 'responded-yes';
                            break;
                        case 'no':
                            statusHTML = '<span class="event-status no">‚ùå ASSENTE</span>';
                            statusClass = 'responded-no';
                            break;
                        case 'maybe':
                            statusHTML = '<span class="event-status maybe">‚ö†Ô∏è FORSE</span>';
                            statusClass = 'responded-maybe';
                            break;
                    }
                } else {
                    if (isToday) {
                        statusHTML = '<span class="event-status pending">üî¥ OGGI!</span>';
                    } else if (isTomorrow) {
                        statusHTML = '<span class="event-status pending">üü† DOMANI</span>';
                    } else {
                        statusHTML = '<span class="event-status pending">‚è≥ DA RISPONDERE</span>';
                    }
                    statusClass = 'not-responded';
                }
                
                // Formatta il giorno in modo pi√π leggibile
                const dayName = formatDate(event.dateObj).split(' ')[0];
                const shortDate = `${event.dateObj.getDate()}/${event.dateObj.getMonth() + 1}`;
                
                return `
                    <div class="event-card ${statusClass}${isToday ? ' today' : ''}" data-event-index="${index}">
                        <div class="event-card-header">
                            <span class="event-type ${getEventTypeClass(event.type)}">${event.tag}</span>
                            ${statusHTML}
                        </div>
                        <h3 class="event-card-title">${event.title}</h3>
                        <p class="event-card-date">üìÖ ${dayName} ${shortDate}</p>
                        <p class="event-card-time">üïê ${event.time}</p>
                        <div class="event-card-buttons">
                            <button class="mini-btn yes" onclick="sendResponse('${event.date}', 'yes', '${event.title}', '${formatDate(event.dateObj)}')" ${buttonsDisabled ? 'disabled' : ''}>‚úÖ</button>
                            <button class="mini-btn no" onclick="sendResponse('${event.date}', 'no', '${event.title}', '${formatDate(event.dateObj)}')" ${buttonsDisabled ? 'disabled' : ''}>‚ùå</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `
                <div class="player-info">
                    <h3>‚öæ #${player.number} ${player.name} ${player.surname}</h3>
                    <p>${player.role}</p>
                </div>
                
                <div class="presence-intro">
                    <h2>üìã Prossimi Eventi</h2>
                    <p>Clicca sui pulsanti per confermare la tua presenza</p>
                </div>
                
                <div class="legend">
                    <div class="legend-item"><span class="legend-dot yes"></span> Presente</div>
                    <div class="legend-item"><span class="legend-dot no"></span> Assente</div>
                    <div class="legend-item"><span class="legend-dot pending"></span> Da rispondere</div>
                </div>
                
                <div class="events-grid">
                    ${eventsHTML}
                </div>
                
                <div style="text-align: center;">
                    <a href="index.html" class="back-btn">‚Üê Torna alla Home</a>
                </div>
            `;
        }
        
        // Nuova funzione per inviare risposta per un evento specifico
        async function sendResponse(eventDate, response, eventTitle, eventDateFormatted) {
            const playerData = JSON.parse(sessionStorage.getItem('playerData'));
            if (!playerData) return;
            
            // Mostra feedback immediato
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥';
            btn.disabled = true;
            
            // Salva la risposta su Firebase
            try {
                await LancersDB.save(playerData.number, eventDate, response);
                console.log('‚úÖ Presenza salvata su Firebase');
                
                // Ricarica per aggiornare lo stato
                await generateContent();
            } catch (error) {
                console.error('‚ùå Errore salvataggio:', error);
                btn.innerHTML = originalText;
                btn.disabled = false;
                alert('Errore nel salvataggio. Riprova.');
            }
        }
        
        // Funzione per rimuovere la risposta
        async function removeResponse(eventDate) {
            const playerData = JSON.parse(sessionStorage.getItem('playerData'));
            if (!playerData) return;
            
            if (!confirm('Vuoi rimuovere la tua risposta per questo evento?')) {
                return;
            }
            
            // Mostra feedback immediato
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥';
            btn.disabled = true;
            
            try {
                // Cancella da Firebase usando PUT con null
                const dateKey = eventDate.replace(/-/g, '_');
                const url = `${LancersDB.baseUrl}/presenze/${playerData.number}/${dateKey}.json`;
                const response = await fetch(url, { 
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(null)
                });
                
                if (response.ok) {
                    console.log('üóëÔ∏è Risposta rimossa da Firebase');
                    // Ricarica per aggiornare lo stato
                    await generateContent();
                } else {
                    throw new Error('Errore nella rimozione');
                }
            } catch (error) {
                console.error('‚ùå Errore rimozione:', error);
                btn.innerHTML = originalText;
                btn.disabled = false;
                alert('Errore nella rimozione. Riprova.');
            }
        }
        
        // Inizializza quando il DOM √® pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                generateContent().catch(error => {
                    console.error('‚ùå Errore generateContent:', error);
                    document.getElementById('presenceSection').innerHTML = `
                        <div class="no-event">
                            <div class="emoji">‚ö†Ô∏è</div>
                            <h2>Errore di caricamento</h2>
                            <p>Si √® verificato un errore. Riprova pi√π tardi.</p>
                            <p style="color: #718096; font-size: 0.85rem; margin-top: 1rem;">${error.message}</p>
                            <a href="index.html" class="back-btn">‚Üê Torna alla Home</a>
                        </div>
                    `;
                });
            });
        } else {
            generateContent().catch(error => {
                console.error('‚ùå Errore generateContent:', error);
                document.getElementById('presenceSection').innerHTML = `
                    <div class="no-event">
                        <div class="emoji">‚ö†Ô∏è</div>
                        <h2>Errore di caricamento</h2>
                        <p>Si √® verificato un errore. Riprova pi√π tardi.</p>
                        <p style="color: #718096; font-size: 0.85rem; margin-top: 1rem;">${error.message}</p>
                        <a href="index.html" class="back-btn">‚Üê Torna alla Home</a>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>

