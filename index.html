<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lancers Baseball - Home</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1a365d">
<meta name="mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1a365d">
<link rel="apple-touch-icon" href="icons/icon-192x192.png"> <meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body>
    <script>
        // Ripristina sessione da localStorage se disponibile
        if (localStorage.getItem('authenticated') === 'true') {
            sessionStorage.setItem('authenticated', 'true');
            const savedPlayer = localStorage.getItem('playerData');
            if (savedPlayer) sessionStorage.setItem('playerData', savedPlayer);
        }
        if (sessionStorage.getItem('authenticated') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>
    <nav class="navbar">
        <div class="nav-brand">
            <div class="baseball-ball logo"></div>
            <span class="team-name">Lancers Baseball</span>
        </div>
        <ul class="nav-links">
            <li><a href="index.html" class="active">ğŸ  Home</a></li>
            <li><a href="calendario-completo.html">ğŸ“… Calendario</a></li>
            <li><a href="allenamenti.html">ğŸ‹ï¸ Allenamenti</a></li>
            <li><a href="calendario.html">âš¾ Partite</a></li>
            <li><a href="presenze.html">ğŸ“‹ Presenze</a></li>
            <li><a href="documento.html">ğŸ“„ Documento</a></li>
            <li><a href="area-personale.html">ğŸ‘¤ Area Personale</a></li>
        </ul>
        <div class="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </nav>

    <main class="hero">
        <div class="hero-content">
            <a href="index.html" style="text-decoration: none;"><h1 style="cursor: pointer;">Lancers Baseball Club</h1></a>
            <p id="welcomeMessage">Benvenuti nella nostra area riservata! Qui trovi tutto ciÃ² che serve per la stagione 2026.</p>
            <div class="hero-buttons">
                <a href="presenze.html" class="btn btn-presence">ğŸ“‹ Conferma Presenza</a>
                <a href="calendario-completo.html" class="btn btn-primary">ğŸ“… Calendario</a>
                <a href="area-personale.html" class="btn btn-personal" id="personalAreaBtn" style="display: none;">ğŸ¯ I Miei Obiettivi</a>
            </div>
        </div>
    </main>

<script>
        // Mostra messaggio personalizzato e pulsante area personale
        const playerData = sessionStorage.getItem('playerData');
        
        document.addEventListener('DOMContentLoaded', async () => {
            if (playerData) {
                const player = JSON.parse(playerData);
                const welcomeMsg = document.getElementById('welcomeMessage');
                if(welcomeMsg) {
                    welcomeMsg.innerHTML = `Ciao <strong>#${player.number} ${player.name} ${player.surname}</strong>! Benvenuto nella tua area riservata.`;
                }
                
                // Mostra pulsante e card area personale
                const personalBtn = document.getElementById('personalAreaBtn');
                if(personalBtn) personalBtn.style.display = 'inline-flex';
                
                const personalCard = document.getElementById('personalCard');
                if(personalCard) personalCard.style.display = 'block';
                
                // Mostra pulsante gestione presenze solo per staff autorizzato
                const authorizedNumbers = [25, 19, 38, 6, 'ADMIN'];
                if (authorizedNumbers.includes(player.number)) {
                    const btnContainer = document.querySelector('.hero-buttons');
                    if (btnContainer && !document.querySelector('.btn-staff')) {
                        const staffBtn = document.createElement('a');
                        staffBtn.href = 'gestione-presenze.html';
                        staffBtn.className = 'btn btn-staff';
                        staffBtn.innerHTML = 'ğŸ“Š Gestione';
                        staffBtn.style.background = 'linear-gradient(135deg, #facc15 0%, #eab308 100%)';
                        staffBtn.style.color = 'var(--text-dark)';
                        staffBtn.style.boxShadow = '0 4px 20px rgba(234,179,8,0.35)';
                        btnContainer.appendChild(staffBtn);
                    }
                }
                
                // Popup promemoria presenza per prossimo evento
                await checkPresenceReminder(player);
            }
        });
        
        async function checkPresenceReminder(player) {
            // Verifica se c'Ã¨ un evento nelle prossime 72 ore senza risposta
            // Usa getPlayerEvents per includere i mercoledÃ¬ personalizzati del giocatore
            
            const now = new Date();
            const hoursAhead = 72; // Controlla eventi nelle prossime 72 ore
            
            // Ottieni eventi personalizzati per questo giocatore
            const playerEvents = (typeof getPlayerEvents === 'function') 
                ? getPlayerEvents(player.number) 
                : allEvents;
            
            // Carica le risposte da Firebase (usa LancersDB se disponibile, altrimenti fetch manuale)
            let responses = {};
            try {
                // Proviamo a usare LancersDB se caricato
                if (typeof LancersDB !== 'undefined') {
                    responses = await LancersDB.getPlayer(player.number);
                } else {
                    // Fallback se firebase-config non Ã¨ caricato o ha errore
                    const baseUrl = 'https://lancersareariservata-default-rtdb.europe-west1.firebasedatabase.app';
                    const res = await fetch(`${baseUrl}/presenze/${player.number}.json`);
                    const data = await res.json();
                    if (data) {
                        Object.entries(data).forEach(([dateKey, value]) => {
                            const normalizedDate = dateKey.replace(/_/g, '-');
                            responses[normalizedDate] = value;
                        });
                    }
                }
            } catch (error) {
                console.error('Errore caricamento presenze:', error);
                return;
            }
            
            for (const event of playerEvents) {
                const eventDate = new Date(event.date);
                const diffHours = (eventDate - now) / (1000 * 60 * 60);
                
                // Logica: se l'evento Ã¨ nel futuro (diffHours > -3 per includere durata evento) 
                // ed entro le 72 ore
                if (diffHours > -3 && diffHours <= hoursAhead) {
                    // Controlla se ha giÃ  risposto
                    if (!responses[event.date]) {
                        // Non ha ancora risposto, mostra popup
                        showInteractivePopup(event, eventDate, player);
                        break; // Mostra solo il primo evento imminente
                    }
                }
            }
        }
        
        function showInteractivePopup(event, eventDate, player) {
            // Evita doppi popup
            if(document.getElementById('presencePopup')) return;

            const days = ['Domenica', 'LunedÃ¬', 'MartedÃ¬', 'MercoledÃ¬', 'GiovedÃ¬', 'VenerdÃ¬', 'Sabato'];
            const months = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            const dateStr = `${days[eventDate.getDay()]} ${eventDate.getDate()} ${months[eventDate.getMonth()]}`;
            
            const popup = document.createElement('div');
            popup.id = 'presencePopup';
            popup.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 1rem; backdrop-filter: blur(8px);">
                    <div style="background: linear-gradient(135deg, #0f2847 0%, #1e3a5f 100%); border-radius: 20px; padding: 2rem; max-width: 400px; width: 100%; text-align: center; animation: slideUp 0.3s ease; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid rgba(59, 130, 246, 0.3);">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">âš¾</div>
                        <h2 style="color: #ffffff; margin-bottom: 0.5rem; font-size: 1.5rem;">Ci sarai?</h2>
                        <p style="color: #94a3b8; margin-bottom: 1.5rem;">Conferma la presenza per il prossimo evento:</p>
                        
                        <div style="background: rgba(59, 130, 246, 0.2); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; border-left: 4px solid #3b82f6; text-align: left;">
                            <strong style="color: #60a5fa; display: block; font-size: 1.1rem; margin-bottom: 0.2rem;">${event.title}</strong>
                            <div style="color: #e2e8f0; font-size: 0.9rem;">ğŸ“… ${dateStr}</div>
                            <div style="color: #e2e8f0; font-size: 0.9rem;">ğŸ• ${event.time}</div>
                        </div>
                        
                        <div style="display: grid; gap: 0.8rem;">
                            <button onclick="quickSavePresence('${event.date}', 'yes')" style="padding: 1rem; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 1rem; transition: transform 0.1s;">âœ… CI SARÃ’</button>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem;">
                                <button onclick="quickSavePresence('${event.date}', 'maybe')" style="padding: 1rem; background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%); color: #1a1a1a; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">âš ï¸ FORSE</button>
                                <button onclick="quickSavePresence('${event.date}', 'no')" style="padding: 1rem; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer;">âŒ ASSENTE</button>
                            </div>
                            
                            <button onclick="document.getElementById('presencePopup').remove()" style="margin-top: 0.5rem; background: none; border: none; color: #94a3b8; cursor: pointer; text-decoration: underline;">Decido dopo</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);
        }

        // Funzione per salvare direttamente dal popup
        async function quickSavePresence(date, status) {
            const popupContent = document.querySelector('#presencePopup > div > div');
            
            // Feedback visivo di caricamento
            popupContent.innerHTML = `
                <div style="padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem; animation: spin 1s linear infinite;">ğŸ”„</div>
                    <h3>Salvataggio in corso...</h3>
                </div>
            `;

            try {
                const player = JSON.parse(sessionStorage.getItem('playerData'));
                
                // Usa LancersDB se disponibile (grazie all'inclusione di firebase-config.js)
                if (typeof LancersDB !== 'undefined') {
                    await LancersDB.save(player.number, date, status);
                } else {
                    // Fallback manuale
                    console.warn("LancersDB non trovato, uso fetch manuale");
                    const baseUrl = 'https://lancersareariservata-default-rtdb.europe-west1.firebasedatabase.app';
                    const payload = {
                        response: status,
                        timestamp: new Date().toISOString()
                    };
                    await fetch(`${baseUrl}/presenze/${player.number}/${date.replace(/\-/g, '_')}.json`, {
                        method: 'PUT',
                        body: JSON.stringify(payload)
                    });
                }

                // Feedback successo
                popupContent.innerHTML = `
                    <div style="padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ‰</div>
                        <h3 style="color: #48bb78;">Risposta salvata!</h3>
                        <p>Grazie per aver risposto.</p>
                    </div>
                `;
                
                // Chiudi dopo 1.5 secondi
                setTimeout(() => {
                    document.getElementById('presencePopup').remove();
                }, 1500);

            } catch (error) {
                console.error(error);
                alert("Errore nel salvataggio. Riprova dalla pagina Presenze.");
                document.getElementById('presencePopup').remove();
            }
        }
    </script>
    <!-- EVENTI SETTIMANA CORRENTE -->
    <section class="weekly-events">
        <div class="weekly-header">
            <h2>ğŸ“… Questa Settimana</h2>
            <p class="week-dates" id="weekDates"></p>
        </div>
        <div class="events-list" id="eventsList">
            <!-- Eventi generati dinamicamente da JavaScript -->
        </div>
        <a href="calendario-completo.html" class="view-all-btn">Vedi calendario completo â†’</a>
    </section>

    <section class="features">
        <div class="feature-card">
            <div class="feature-icon">ğŸ“‹</div>
            <h3>Presenze</h3>
            <p>âœ… Conferma la tua presenza agli allenamenti e alle partite.</p>
            <a href="presenze.html" class="feature-link">Conferma presenza â†’</a>
        </div>
        <div class="feature-card">
            <div class="feature-icon">ğŸ“…</div>
            <h3>Calendario Completo</h3>
            <p>ğŸ“† Tutto in un'unica vista: allenamenti, amichevoli e partite.</p>
            <a href="calendario-completo.html" class="feature-link">Vedi calendario â†’</a>
        </div>
        <div class="feature-card">
            <div class="feature-icon">âš¾</div>
            <h3>Partite Serie B</h3>
            <p>ğŸ† Calendario delle partite di campionato.</p>
            <a href="calendario.html" class="feature-link">Vedi partite â†’</a>
        </div>
        <div class="feature-card">
            <div class="feature-icon">ğŸ‹ï¸</div>
            <h3>Allenamenti</h3>
            <p>ğŸ’ª Sessioni di preparazione: atletica, tecnica e specifici.</p>
            <a href="allenamenti.html" class="feature-link">Vedi allenamenti â†’</a>
        </div>
        <div class="feature-card">
            <div class="feature-icon">ğŸ“„</div>
            <h3>Documento</h3>
            <p>ğŸ“‹ Piano di sviluppo, obiettivi e regolamento.</p>
            <a href="documento.html" class="feature-link">Vai al documento â†’</a>
        </div>
        <div class="feature-card" id="personalCard" style="display: none;">
            <div class="feature-icon">ğŸ¯</div>
            <h3>Area Personale</h3>
            <p>ğŸ‘¤ I tuoi obiettivi, statistiche e progressi.</p>
            <a href="area-personale.html" class="feature-link">Vai all'area personale â†’</a>
        </div>
    </section>

    <footer>
        <p>âš¾ Â© 2026 Lancers Baseball Club - Serie B Federazione Italiana Baseball Softball</p>
        <p class="footer-motto">"Play Hard, Play Fair, Play Together" ğŸ†</p>
        <button id="logoutBtn" class="footer-logout-btn">ğŸšª Logout</button>
    </footer>
    <script src="firebase-config.js"></script>
    <script src="script.js?v=44"></script>
</body>
</html>
