    <!-- Tab Bar fissa in basso -->
        <nav class="tab-bar">
    <a href="index.html" class="tab-bar-item" title="Home">
        <span>üè†</span>
        <span>Home</span>
    </a>
    <a href="calendario-completo.html" class="tab-bar-item" title="Calendario">
        <span>üìÖ</span>
        <span>Calendario</span>
    </a>
    <a href="calendario.html" class="tab-bar-item active" title="Partite">
        <span>‚öæ</span>
        <span>Partite</span>
    </a>
    <a href="area-personale.html" class="tab-bar-item" title="Profilo">
        <span>üë§</span>
        <span>Profilo</span>
    </a>
</nav>
<style>
    .tab-bar {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        height: 64px;
        background: linear-gradient(135deg, #0a1929 0%, #1a365d 100%);
        display: flex;
        justify-content: space-around;
        align-items: center;
        box-shadow: 0 -2px 16px rgba(0,0,0,0.15);
        z-index: 9999;
        width: 100vw;
        max-width: 100vw;
        min-width: 0;
    }
    .tab-bar-item {
        flex: 1;
        text-align: center;
        color: #94a3b8;
        text-decoration: none;
        font-size: 1.1rem;
        font-weight: 600;
        padding: 0.5rem 0;
        transition: color 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .tab-bar-item span:first-child {
        font-size: 1.5rem;
        margin-bottom: 0.2rem;
    }
    .tab-bar-item span:last-child {
        display: block;
    }
    .tab-bar-item:hover, .tab-bar-item.active {
        color: #f59e0b;
    }
    body { padding-bottom: 70px; }
    html, body {
        height: 100%;
        min-height: 100vh;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    @media (max-width: 420px) {
        .tab-bar {
            height: 48px;
            width: 100vw;
        }
        .tab-bar-item span:last-child {
            font-size: 0.7rem;
        }
        .tab-bar-item span:first-child {
            font-size: 1.2rem;
        }
    }
</style>
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Partite - Lancers Baseball</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a365d">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <meta name="mobile-web-app-capable" content="yes">
    <style>
        .match-card {
            background: rgba(15, 40, 71, 0.8);
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            overflow: hidden;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        .match-header {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            cursor: pointer;
            gap: 1rem;
            background: linear-gradient(135deg, #0f2847 0%, #1e3a5f 100%);
            color: white;
            user-select: none;
        }
        .match-header.home { background: linear-gradient(135deg, #166534 0%, #22c55e 100%); }
        .match-header.away { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); }
        .match-header.friendly { background: linear-gradient(135deg, #991b1b 0%, #dc2626 100%); }
        
        .match-date {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            text-align: center;
            min-width: 60px;
        }
        .match-date .day { display: block; font-size: 1.5rem; font-weight: 700; }
        .match-date .month { font-size: 0.75rem; opacity: 0.9; }
        
        .match-info { flex: 1; }
        .match-info h3 { margin: 0 0 0.25rem 0; font-size: 1.1rem; }
        .match-info span { opacity: 0.9; font-size: 0.85rem; }
        
        .match-arrow {
            font-size: 1.2rem;
            transition: transform 0.3s;
        }
        .match-card.open .match-arrow { transform: rotate(180deg); }
        
        .match-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(10, 22, 40, 0.9);
        }
        .match-card.open .match-details { max-height: 2000px; }
        
        .match-details-inner {
            padding: 1.5rem;
        }
        .detail-row {
            display: flex;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }
        .detail-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .detail-row strong { min-width: 120px; color: #60a5fa; }
        .detail-row span { color: #e2e8f0; }
        
        .section-title {
            background: linear-gradient(135deg, #0f2847 0%, #1e3a5f 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin: 2rem 0 1rem 0;
            font-size: 1.2rem;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .map-btn {
            display: inline-block;
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        .map-btn:hover { background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); }

        /* Trasporti Display */
        .trasporti-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(59, 130, 246, 0.2);
        }
        .trasporti-title {
            color: #3b82f6;
            font-weight: 700;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }
        .vehicle-display {
            background: rgba(59, 130, 246, 0.1);
            border-radius: 10px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .vehicle-display-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .vehicle-icon { font-size: 1.2rem; }
        .driver-name { font-weight: 700; color: white; }
        .seats-info { color: #60a5fa; font-size: 0.85rem; margin-left: auto; }
        .passengers-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .passenger-tag {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.25rem 0.6rem;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #e2e8f0;
        }
        .no-trasporti {
            color: #94a3b8;
            font-style: italic;
            font-size: 0.9rem;
        }

        /* Gestione Trasporti Modal */
        .trasporti-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 1rem;
        }
        .trasporti-modal.open { display: block; }
        .trasporti-modal-content {
            max-width: 800px;
            margin: 2rem auto;
            background: linear-gradient(135deg, #0f2847 0%, #1e3a5f 100%);
            border-radius: 16px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            overflow: hidden;
        }
        .trasporti-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }
        .trasporti-modal-header h2 {
            margin: 0;
            color: #60a5fa;
            font-size: 1.2rem;
        }
        .trasporti-modal-close {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3rem;
        }
        .trasporti-modal-body {
            padding: 1.5rem;
        }

        /* Veicoli Interattivi */
        .vehicle-interactive {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .vehicle-interactive-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .vehicle-interactive-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .vehicle-icon-large { font-size: 1.5rem; }
        .vehicle-driver-info h4 {
            margin: 0;
            color: white;
            font-size: 1rem;
        }
        .vehicle-driver-info span {
            color: #94a3b8;
            font-size: 0.85rem;
        }
        .seats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 0.5rem;
        }
        .seat-slot {
            background: rgba(0,0,0,0.3);
            border: 2px dashed rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 0.6rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            color: #94a3b8;
            font-size: 0.85rem;
        }
        .seat-slot:hover:not(.occupied):not(.driver-seat) {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
        }
        .seat-slot.occupied {
            background: rgba(34, 197, 94, 0.2);
            border: 2px solid rgba(34, 197, 94, 0.5);
            color: #22c55e;
            cursor: default;
        }
        .seat-slot.my-seat {
            background: rgba(234, 179, 8, 0.2);
            border: 2px solid rgba(234, 179, 8, 0.5);
            color: #eab308;
            cursor: pointer;
        }
        .seat-slot.driver-seat {
            background: rgba(59, 130, 246, 0.2);
            border: 2px solid rgba(59, 130, 246, 0.5);
            color: #3b82f6;
        }
        .seat-slot.driver-free {
            cursor: pointer;
        }

        /* Aggiungi Veicolo Utente */
        .add-my-vehicle-section {
            background: rgba(34, 197, 94, 0.1);
            border: 2px dashed rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            margin-top: 1rem;
        }
        .add-my-vehicle-section h4 {
            color: #22c55e;
            margin: 0 0 1rem 0;
        }
        .add-vehicle-form {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        .add-vehicle-form select, .add-vehicle-form button {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-family: 'Montserrat', sans-serif;
        }
        .add-vehicle-form select {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
        }
        .add-vehicle-form button {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        /* Note Veicolo */
        .vehicle-notes {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .vehicle-notes-text {
            color: #94a3b8;
            font-size: 0.85rem;
            font-style: italic;
        }

        /* Summary Chi Manca */
        .missing-summary {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .missing-summary h4 {
            color: #ef4444;
            margin: 0 0 0.5rem 0;
            font-size: 0.95rem;
        }
        .missing-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .missing-tag {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            padding: 0.25rem 0.6rem;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        .all-assigned {
            color: #22c55e;
            font-size: 0.9rem;
        }

        /* Tasto Gestisci Trasporti */
        .manage-trasporti-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            margin-top: 1rem;
            transition: all 0.3s;
        }
        .manage-trasporti-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body>
    <script>
        // Ripristina sessione da localStorage se disponibile
        if (localStorage.getItem('authenticated') === 'true') {
            sessionStorage.setItem('authenticated', 'true');
            const savedPlayer = localStorage.getItem('playerData');
            if (savedPlayer) sessionStorage.setItem('playerData', savedPlayer);
        }
        if (sessionStorage.getItem('authenticated') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>
    <nav class="navbar">
        <a href="index.html" class="nav-brand" style="text-decoration:none;color:inherit;">
            <div class="baseball-ball logo"></div>
            <span class="team-name">Lancers Baseball</span>
        </a>
        <ul class="nav-links">
            <li><a href="index.html">üè† Home</a></li>
            <li><a href="calendario-completo.html">üìÖ Calendario</a></li>
            <li><a href="allenamenti.html">üèãÔ∏è Allenamenti</a></li>
            <li><a href="calendario.html" class="active">‚öæ Partite</a></li>
            <li><a href="presenze.html">üìã Presenze</a></li>
            <li><a href="documento.html">üìÑ Documento</a></li>
            <li><a href="area-personale.html">üë§ Area Personale</a></li>
        </ul>
        <div class="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </nav>

    <main class="page-content">
        <div class="page-header">
            <h1>üìÖ Calendario Partite 2026</h1>
            <p>Clicca su ogni partita per vedere i dettagli</p>
        </div>

        <div class="calendar-container">
            
            <!-- AMICHEVOLI -->
            <h2 class="section-title">ü§ù AMICHEVOLI - Marzo</h2>
            
            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header friendly">
                    <div class="match-date"><span class="day">01</span><span class="month">MAR</span></div>
                    <div class="match-info"><h3>üè† Amichevole Interna</h3><span>Domenica - Casa - 10:00</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üïê Ritrovo:</strong><span>09:30 al campo</span></div>
                        <div class="detail-row"><strong>‚öæ Inizio:</strong><span>10:00</span></div>
                        <div class="detail-row"><strong>üìç Luogo:</strong><span>Campo Lancers - Casa</span></div>
                        <div class="detail-row"><strong>üìù Note:</strong><span>Amichevole interna preparazione stagione</span></div>
                    </div>
                </div>
            </div>

            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header friendly">
                    <div class="match-date"><span class="day">08</span><span class="month">MAR</span></div>
                    <div class="match-info"><h3>üè† vs Castenaso/Phoenix</h3><span>Domenica - Casa - 10:00</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üïê Ritrovo:</strong><span>09:30 al campo</span></div>
                        <div class="detail-row"><strong>‚öæ Inizio:</strong><span>10:00</span></div>
                        <div class="detail-row"><strong>üìç Luogo:</strong><span>Campo Lancers - Casa</span></div>
                        <div class="detail-row"><strong>üìù Note:</strong><span>Amichevole pre-stagione</span></div>
                    </div>
                </div>
            </div>

            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header away">
                    <div class="match-date"><span class="day">14</span><span class="month">MAR</span></div>
                    <div class="match-info"><h3>‚úàÔ∏è @ Fortitudo Bologna</h3><span>Sabato - Trasferta - 11:00</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üïê Ritrovo:</strong><span>Da definire</span></div>
                        <div class="detail-row"><strong>‚öæ Inizio:</strong><span>11:00</span></div>
                        <div class="detail-row"><strong>üìç Campo:</strong><span>Stadio Gianni Falchi, Bologna</span></div>
                        <a href="https://maps.google.com/?q=Stadio+Gianni+Falchi+Bologna" target="_blank" class="map-btn">üìç Apri Maps</a>
                    </div>
                </div>
            </div>

            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header away">
                    <div class="match-date"><span class="day">22</span><span class="month">MAR</span></div>
                    <div class="match-info"><h3>‚úàÔ∏è @ Fiorentina</h3><span>Domenica - Trasferta - 11:00</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üïê Ritrovo:</strong><span>Da definire</span></div>
                        <div class="detail-row"><strong>‚öæ Inizio:</strong><span>11:00</span></div>
                        <div class="detail-row"><strong>üìç Campo:</strong><span>Campo Fiorentina Baseball, Firenze</span></div>
                        <a href="https://maps.google.com/?q=Fiorentina+Baseball+Firenze" target="_blank" class="map-btn">üìç Apri Maps</a>
                    </div>
                </div>
            </div>

            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header friendly">
                    <div class="match-date"><span class="day">29</span><span class="month">MAR</span></div>
                    <div class="match-info"><h3>üè† vs A.S.D BSC Arezzo</h3><span>Domenica - Casa - 11:00</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üïê Ritrovo:</strong><span>10:00 al campo</span></div>
                        <div class="detail-row"><strong>‚öæ Inizio:</strong><span>11:00</span></div>
                        <div class="detail-row"><strong>üìç Luogo:</strong><span>Campo Lancers - Casa</span></div>
                    </div>
                </div>
            </div>

            <!-- CAMPIONATO ANDATA -->
            <h2 class="section-title">‚öæ CAMPIONATO - Girone di Andata</h2>

            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header away">
                    <div class="match-date"><span class="day">12</span><span class="month">APR</span></div>
                    <div class="match-info"><h3>‚úàÔ∏è @ Health & Performance S.S.D</h3><span>Sabato - Trasferta - 11:00 - 1¬™ Giornata</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üïê Ritrovo:</strong><span>Da definire</span></div>
                        <div class="detail-row"><strong>‚öæ Inizio:</strong><span>11:00</span></div>
                        <div class="detail-row"><strong>üìç Campo:</strong><span>Campo Health & Performance</span></div>
                        <a href="https://maps.google.com/?q=Health+Performance+Baseball" target="_blank" class="map-btn">üìç Apri Maps</a>
                    </div>
                </div>
            </div>

            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header away">
                    <div class="match-date"><span class="day">19</span><span class="month">APR</span></div>
                    <div class="match-info"><h3>‚úàÔ∏è @ Livorno 1940 Baseball</h3><span>Domenica - Trasferta - 11:00 - 2¬™ Giornata</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üïê Ritrovo:</strong><span>Da definire</span></div>
                        <div class="detail-row"><strong>‚öæ Inizio:</strong><span>11:00</span></div>
                        <div class="detail-row"><strong>üìç Campo:</strong><span>Campo Livorno 1940</span></div>
                        <a href="https://maps.google.com/?q=Livorno+Baseball" target="_blank" class="map-btn">üìç Apri Maps</a>
                    </div>
                </div>
            </div>

            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header home">
                    <div class="match-date"><span class="day">26</span><span class="month">APR</span></div>
                    <div class="match-info"><h3>üè† vs Longbridge 2000 B.C</h3><span>Domenica - Casa - 11:00 - 3¬™ Giornata</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üïê Ritrovo:</strong><span>10:00 al campo</span></div>
                        <div class="detail-row"><strong>‚öæ Inizio:</strong><span>11:00</span></div>
                        <div class="detail-row"><strong>üìç Luogo:</strong><span>Campo Lancers</span></div>
                    </div>
                </div>
            </div>

            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header away">
                    <div class="match-date"><span class="day">03</span><span class="month">MAG</span></div>
                    <div class="match-info"><h3>‚úàÔ∏è @ Colorno B.C.</h3><span>Domenica - Trasferta - 11:00 - 4¬™ Giornata</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üïê Ritrovo:</strong><span>Da definire</span></div>
                        <div class="detail-row"><strong>‚öæ Inizio:</strong><span>11:00</span></div>
                        <div class="detail-row"><strong>üìç Campo:</strong><span>Campo Colorno B.C.</span></div>
                        <a href="https://maps.google.com/?q=Colorno+Baseball+Parma" target="_blank" class="map-btn">üìç Apri Maps</a>
                    </div>
                </div>
            </div>

            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header home">
                    <div class="match-date"><span class="day">10</span><span class="month">MAG</span></div>
                    <div class="match-info"><h3>üè† vs A.S.D BSC Arezzo</h3><span>Domenica - Casa - 11:00 - 5¬™ Giornata</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üïê Ritrovo:</strong><span>10:00 al campo</span></div>
                        <div class="detail-row"><strong>‚öæ Inizio:</strong><span>11:00</span></div>
                        <div class="detail-row"><strong>üìç Luogo:</strong><span>Campo Lancers</span></div>
                    </div>
                </div>
            </div>

            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header home">
                    <div class="match-date"><span class="day">17</span><span class="month">MAG</span></div>
                    <div class="match-info"><h3>üè† vs Cali Roma XII</h3><span>Domenica - Casa - 11:00 - 6¬™ Giornata</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üïê Ritrovo:</strong><span>10:00 al campo</span></div>
                        <div class="detail-row"><strong>‚öæ Inizio:</strong><span>11:00</span></div>
                        <div class="detail-row"><strong>üìç Luogo:</strong><span>Campo Lancers</span></div>
                    </div>
                </div>
            </div>

            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header away">
                    <div class="match-date"><span class="day">30</span><span class="month">MAG</span></div>
                    <div class="match-info"><h3>‚úàÔ∏è @ Padule Baseball A.S.D</h3><span>Sabato - Trasferta - 15:00 - 7¬™ Giornata</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üïê Ritrovo:</strong><span>Da definire</span></div>
                        <div class="detail-row"><strong>‚öæ Inizio:</strong><span>15:00</span></div>
                        <div class="detail-row"><strong>üìç Campo:</strong><span>Campo Padule Baseball</span></div>
                        <a href="https://maps.google.com/?q=Padule+Baseball" target="_blank" class="map-btn">üìç Apri Maps</a>
                    </div>
                </div>
            </div>

            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header home">
                    <div class="match-date"><span class="day">07</span><span class="month">GIU</span></div>
                    <div class="match-info"><h3>üè† vs Health & Performance S.S.D</h3><span>Domenica - Casa - 11:00</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üïê Ritrovo:</strong><span>10:00 al campo</span></div>
                        <div class="detail-row"><strong>‚öæ Inizio:</strong><span>11:00</span></div>
                        <div class="detail-row"><strong>üìç Luogo:</strong><span>Campo Lancers</span></div>
                    </div>
                </div>
            </div>

            <!-- CAMPIONATO RITORNO -->
            <h2 class="section-title">‚öæ CAMPIONATO - Girone di Ritorno</h2>

            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header home">
                    <div class="match-date"><span class="day">14</span><span class="month">GIU</span></div>
                    <div class="match-info"><h3>üè† vs Livorno 1940 Baseball</h3><span>Domenica - Casa - 11:00</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üïê Ritrovo:</strong><span>10:00 al campo</span></div>
                        <div class="detail-row"><strong>‚öæ Inizio:</strong><span>11:00</span></div>
                        <div class="detail-row"><strong>üìç Luogo:</strong><span>Campo Lancers</span></div>
                    </div>
                </div>
            </div>

            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header away">
                    <div class="match-date"><span class="day">21</span><span class="month">GIU</span></div>
                    <div class="match-info"><h3>‚úàÔ∏è @ Longbridge 2000 B.C</h3><span>Domenica - Trasferta - 11:00</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üïê Ritrovo:</strong><span>Da definire</span></div>
                        <div class="detail-row"><strong>‚öæ Inizio:</strong><span>11:00</span></div>
                        <div class="detail-row"><strong>üìç Campo:</strong><span>Campo Longbridge 2000</span></div>
                        <a href="https://maps.google.com/?q=Longbridge+2000+Baseball" target="_blank" class="map-btn">üìç Apri Maps</a>
                    </div>
                </div>
            </div>

            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header home">
                    <div class="match-date"><span class="day">28</span><span class="month">GIU</span></div>
                    <div class="match-info"><h3>üè† vs Colorno B.C.</h3><span>Domenica - Casa - 11:00</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üïê Ritrovo:</strong><span>10:00 al campo</span></div>
                        <div class="detail-row"><strong>‚öæ Inizio:</strong><span>11:00</span></div>
                        <div class="detail-row"><strong>üìç Luogo:</strong><span>Campo Lancers</span></div>
                    </div>
                </div>
            </div>

            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header away">
                    <div class="match-date"><span class="day">05</span><span class="month">LUG</span></div>
                    <div class="match-info"><h3>‚úàÔ∏è @ A.S.D BSC Arezzo</h3><span>Domenica - Trasferta - 11:00</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üïê Ritrovo:</strong><span>Da definire</span></div>
                        <div class="detail-row"><strong>‚öæ Inizio:</strong><span>11:00</span></div>
                        <div class="detail-row"><strong>üìç Campo:</strong><span>Campo BSC Arezzo</span></div>
                        <a href="https://maps.google.com/?q=BSC+Arezzo+Baseball" target="_blank" class="map-btn">üìç Apri Maps</a>
                    </div>
                </div>
            </div>

            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header away">
                    <div class="match-date"><span class="day">12</span><span class="month">LUG</span></div>
                    <div class="match-info"><h3>‚úàÔ∏è @ Cali Roma XII</h3><span>Domenica - Trasferta - 11:00</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üïê Ritrovo:</strong><span>Da definire</span></div>
                        <div class="detail-row"><strong>‚öæ Inizio:</strong><span>11:00</span></div>
                        <div class="detail-row"><strong>üìç Campo:</strong><span>Campo Cali Roma XII</span></div>
                        <a href="https://maps.google.com/?q=Cali+Roma+Baseball" target="_blank" class="map-btn">üìç Apri Maps</a>
                    </div>
                </div>
            </div>

            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header home">
                    <div class="match-date"><span class="day">26</span><span class="month">LUG</span></div>
                    <div class="match-info"><h3>üè† vs Padule Baseball A.S.D</h3><span>Domenica - Casa - 11:00</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üïê Ritrovo:</strong><span>10:00 al campo</span></div>
                        <div class="detail-row"><strong>‚öæ Inizio:</strong><span>11:00</span></div>
                        <div class="detail-row"><strong>üìç Luogo:</strong><span>Campo Lancers</span></div>
                        <div class="detail-row"><strong>‚ÑπÔ∏è Note:</strong><span>Ritorno</span></div>
                    </div>
                </div>
            </div>

            <!-- POST SEASON -->
            <h2 class="section-title">üèÜ POST SEASON</h2>

            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header friendly">
                    <div class="match-date"><span class="day">22</span><span class="month">AGO</span></div>
                    <div class="match-info"><h3>üèÜ Playoff/Playout</h3><span>Da definire</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üìù Note:</strong><span>In base alla classifica finale</span></div>
                    </div>
                </div>
            </div>

            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header friendly">
                    <div class="match-date"><span class="day">29</span><span class="month">AGO</span></div>
                    <div class="match-info"><h3>üèÜ Playoff/Playout</h3><span>Da definire</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üìù Note:</strong><span>In base alla classifica finale</span></div>
                    </div>
                </div>
            </div>

            <div class="match-card" onclick="toggleCard(this)">
                <div class="match-header friendly">
                    <div class="match-date"><span class="day">06</span><span class="month">SET</span></div>
                    <div class="match-info"><h3>üèÜ Eventuale Recupero Playoff/Playout</h3><span>Da definire</span></div>
                    <span class="match-arrow">‚ñº</span>
                </div>
                <div class="match-details">
                    <div class="match-details-inner">
                        <div class="detail-row"><strong>üìù Note:</strong><span>In base alla classifica finale</span></div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2026 Lancers Baseball Club - Area Riservata</p>
        <button id="logoutBtn" class="footer-logout-btn">üö™ Logout</button>
    </footer>

    <!-- Modal Gestione Trasporti -->
    <div id="trasportiModal" class="trasporti-modal">
        <div class="trasporti-modal-content">
            <div class="trasporti-modal-header">
                <h2 id="modalMatchTitle">üöó Gestione Trasporti</h2>
                <button class="trasporti-modal-close" onclick="closeTrasportiModal()">‚úï</button>
            </div>
            <div class="trasporti-modal-body" id="modalBody">
                <!-- Contenuto dinamico -->
            </div>
        </div>
    </div>

    <script src="script.js?v=57"></script>
    <script>
        // Toggle per le card - SOLO sul banner header, non sulle info
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.querySelector('.calendar-container');
            if (container) {
                container.addEventListener('click', function(e) {
                    // Ignora click su link, bottoni, e tutto dentro match-details
                    if (e.target.closest('a') || e.target.closest('button') || e.target.closest('.match-details')) return;
                    
                    // Toggle solo se click √® sul header
                    const header = e.target.closest('.match-header');
                    if (header) {
                        const card = header.closest('.match-card');
                        if (card) {
                            e.stopPropagation();
                            card.classList.toggle('open');
                        }
                    }
                });
            }
            
            // Carica trasporti per le partite in trasferta
            loadTrasportiForCalendar();
        });

        // Funzione toggleCard disabilitata per evitare doppio toggle
        function toggleCard(card) {
            // Non fare nulla - il toggle √® gestito dall'event delegation
            // Questo evita il doppio toggle quando onclick e delegation scattano insieme
        }
        
        // Lista giocatori per mapping
        const playersList = [
            { number: 0, name: 'Niccol√≤ Bucci' },
            { number: 1, name: 'Alessandro Ferrini' },
            { number: 3, name: 'Ettore Della Nave' },
            { number: 4, name: 'Giovanni G. Beudean' },
            { number: 6, name: 'Simone Geri' },
            { number: 7, name: 'Silvano Albano' },
            { number: 8, name: 'Tommaso Panichi' },
            { number: 12, name: 'Francesco Grassi' },
            { number: 14, name: 'Leonardo Scarpulla' },
            { number: 19, name: 'Simone Baratella' },
            { number: 22, name: 'Giuseppe G. Grado' },
            { number: 24, name: 'Guido Nannucci' },
            { number: 25, name: 'Lorenzo Scarpulla' },
            { number: 32, name: 'Filippo Anichini' },
            { number: 38, name: 'Antonio Parrini' },
            { number: 59, name: 'Lapo Biondi' },
            { number: 77, name: 'Cosimo Rinaldi' },
            { number: 89, name: 'Daniele Silvestri' },
            { number: 90, name: 'Alessandro Rrethatori' },
            { number: 98, name: 'Francesco Paperini' },
            { number: 99, name: 'Victor Vergara' }
        ];
        
        function getPlayerName(num) {
            const p = playersList.find(pl => pl.number == num);
            return p ? p.name : `#${num}`;
        }
        
        // Mappa date partite -> card
        const matchDateMap = {
            '2026-03-14': '14MAR',
            '2026-03-22': '22MAR',
            '2026-04-12': '12APR',
            '2026-04-19': '19APR',
            '2026-05-03': '03MAG',
            '2026-05-30': '30MAG',
            '2026-06-21': '21GIU',
            '2026-07-05': '05LUG',
            '2026-07-12': '12LUG',
            '2026-07-26': '26LUG'
        };
        
        async function loadTrasportiForCalendar() {
            const FIREBASE_URL = 'https://lancersareariservata-default-rtdb.europe-west1.firebasedatabase.app';
            
            try {
                const response = await fetch(`${FIREBASE_URL}/trasporti.json`);
                const allTrasporti = await response.json() || {};
                
                // Trova tutte le card trasferta
                const cards = document.querySelectorAll('.match-card');
                cards.forEach(card => {
                    const header = card.querySelector('.match-header');
                    if (!header || !header.classList.contains('away')) return;
                    
                    const dateSpan = card.querySelector('.match-date');
                    const day = dateSpan?.querySelector('.day')?.textContent;
                    const month = dateSpan?.querySelector('.month')?.textContent;
                    if (!day || !month) return;
                    
                    const cardKey = `${day}${month}`;
                    
                    // Trova matchId corrispondente
                    let matchId = null;
                    for (const [id, key] of Object.entries(matchDateMap)) {
                        if (key === cardKey) {
                            matchId = id;
                            break;
                        }
                    }
                    
                    if (!matchId) return;
                    
                    const details = card.querySelector('.match-details-inner');
                    if (!details || details.querySelector('.trasporti-section')) return;
                    
                    const data = allTrasporti[matchId];
                    if (data && data.vehicles && data.vehicles.length > 0) {
                        // Ha trasporti configurati
                        details.insertAdjacentHTML('beforeend', renderTrasportiSection(data.vehicles, matchId));
                    } else {
                        // Non ha trasporti - mostra solo bottone
                        details.insertAdjacentHTML('beforeend', `
                            <div class="trasporti-section">
                                <div class="trasporti-title">üöó Trasporti</div>
                                <p class="no-trasporti">Nessun veicolo ancora configurato.</p>
                                <button class="manage-trasporti-btn" onclick="openTrasportiModal('${matchId}')">üöó Gestisci Trasporti</button>
                            </div>
                        `);
                    }
                });
            } catch (e) {
                console.error('Errore caricamento trasporti:', e);
            }
        }
        
        function renderTrasportiSection(vehicles, matchId) {
            let html = '<div class="trasporti-section"><div class="trasporti-title">üöó Trasporti</div>';
            
            // Calcola chi ha posto e chi no
            const assignedPeople = new Set();
            vehicles.forEach(v => {
                if (v.driver) assignedPeople.add(v.driver);
                if (v.driverName && !v.driver) assignedPeople.add(v.driverName);
                (v.passengers || []).forEach((p, i) => {
                    if (p) assignedPeople.add(p);
                    else if (v.passengerNames && v.passengerNames[i]) assignedPeople.add(v.passengerNames[i]);
                });
            });
            
            // Chi manca
            const missingPlayers = playersList.filter(p => !assignedPeople.has(String(p.number)));
            const totalSeats = vehicles.reduce((sum, v) => sum + v.seats, 0);
            const usedSeats = assignedPeople.size;
            
            // Summary chi manca
            if (missingPlayers.length > 0) {
                html += `<div class="missing-summary">
                    <h4>‚ö†Ô∏è Senza posto (${missingPlayers.length}):</h4>
                    <div class="missing-list">
                        ${missingPlayers.map(p => `<span class="missing-tag">#${p.number} ${p.name.split(' ')[0]}</span>`).join('')}
                    </div>
                </div>`;
            } else {
                html += `<p class="all-assigned">‚úÖ Tutti i giocatori hanno un posto!</p>`;
            }
            
            vehicles.forEach((v, idx) => {
                // Usa driverName se disponibile, altrimenti cerca per numero
                const driverName = v.driverName || (v.driver ? getPlayerName(v.driver) : 'Da assegnare');
                
                // Usa passengerNames se disponibili, altrimenti cerca per numero
                const passengerNames = v.passengerNames || [];
                const passengerIds = v.passengers || [];
                const passengers = passengerIds
                    .map((p, i) => passengerNames[i] || (p ? getPlayerName(p) : null))
                    .filter(p => p);
                
                html += `
                    <div class="vehicle-display">
                        <div class="vehicle-display-header">
                            <span class="vehicle-icon">üöó</span>
                            <span class="driver-name">${driverName}</span>
                            <span class="seats-info">${passengers.length + (v.driver || v.driverName ? 1 : 0)}/${v.seats} posti</span>
                        </div>
                        ${passengers.length > 0 ? `
                            <div class="passengers-list">
                                ${passengers.map(p => `<span class="passenger-tag">${p}</span>`).join('')}
                            </div>
                        ` : '<span class="no-trasporti">Nessun passeggero assegnato</span>'}
                        ${v.notes ? `<div class="vehicle-notes"><span class="vehicle-notes-text">üìù ${v.notes}</span></div>` : ''}
                    </div>
                `;
            });
            
            // Tasto gestisci trasporti
            html += `<button class="manage-trasporti-btn" onclick="openTrasportiModal('${matchId}')">üöó Gestisci Trasporti</button>`;
            
            html += '</div>';
            return html;
        }
        
        // ==========================================
        // GESTIONE TRASPORTI MODAL
        // ==========================================
        
        const FIREBASE_URL = 'https://lancersareariservata-default-rtdb.europe-west1.firebasedatabase.app';
        let currentModalMatchId = null;
        let currentModalTrasporti = { vehicles: [] };
        const currentPlayerData = JSON.parse(sessionStorage.getItem('playerData') || '{}');
        const isAdmin = [25, 19, 38, 6, 'ADMIN'].includes(currentPlayerData.number);
        
        function openTrasportiModal(matchId) {
            currentModalMatchId = matchId;
            document.getElementById('trasportiModal').classList.add('open');
            document.getElementById('modalMatchTitle').textContent = 'üöó Trasporti - ' + getMatchName(matchId);
            loadModalTrasporti(matchId);
        }
        
        function closeTrasportiModal() {
            document.getElementById('trasportiModal').classList.remove('open');
            currentModalMatchId = null;
            // Ricarica trasporti per aggiornare visualizzazione
            loadTrasportiForCalendar();
        }
        
        function getMatchName(matchId) {
            const names = {
                '2026-03-14': 'Fortitudo Bologna',
                '2026-03-22': 'Fiorentina',
                '2026-04-12': 'Health & Performance',
                '2026-04-19': 'Livorno 1940',
                '2026-05-03': 'Colorno B.C.',
                '2026-05-30': 'Padule Baseball',
                '2026-06-21': 'Longbridge 2000',
                '2026-07-05': 'BSC Arezzo',
                '2026-07-12': 'Cali Roma XII',
                '2026-07-26': 'Padule Baseball'
            };
            return names[matchId] || matchId;
        }
        
        async function loadModalTrasporti(matchId) {
            const body = document.getElementById('modalBody');
            body.innerHTML = '<p style="text-align:center; color:#94a3b8;">‚è≥ Caricamento...</p>';
            
            try {
                const response = await fetch(`${FIREBASE_URL}/trasporti/${matchId}.json`);
                const data = await response.json();
                currentModalTrasporti = data && data.vehicles ? data : { vehicles: [] };
                renderModalContent();
            } catch (e) {
                console.error('Errore:', e);
                currentModalTrasporti = { vehicles: [] };
                renderModalContent();
            }
        }
        
        function getCurrentPlayerIdentifier() {
            // Ritorna identificatore univoco del giocatore corrente
            return String(currentPlayerData.number);
        }
        
        function isPersonInAnyVehicle(personId) {
            // Controlla se la persona √® gi√† in qualche veicolo
            for (const v of currentModalTrasporti.vehicles) {
                if (String(v.driver) === String(personId)) return true;
                if (v.driverName && v.driverName.includes(`#${personId}`)) return true;
                if (v.passengers) {
                    for (let i = 0; i < v.passengers.length; i++) {
                        if (String(v.passengers[i]) === String(personId)) return true;
                        if (v.passengerNames && v.passengerNames[i] && v.passengerNames[i].includes(`#${personId}`)) return true;
                    }
                }
            }
            return false;
        }
        
        function renderModalContent() {
            const body = document.getElementById('modalBody');
            const myId = getCurrentPlayerIdentifier();
            const amIAssigned = isPersonInAnyVehicle(myId);
            
            // Calcola persone gi√† assegnate
            const assignedPeople = new Set();
            currentModalTrasporti.vehicles.forEach(v => {
                if (v.driver) assignedPeople.add(String(v.driver));
                (v.passengers || []).forEach(p => { if (p) assignedPeople.add(String(p)); });
            });
            
            // Chi manca
            const missingPlayers = playersList.filter(p => !assignedPeople.has(String(p.number)));
            
            let html = '';
            
            // Summary chi manca
            if (missingPlayers.length > 0) {
                html += `<div class="missing-summary">
                    <h4>‚ö†Ô∏è Senza posto (${missingPlayers.length}):</h4>
                    <div class="missing-list">
                        ${missingPlayers.map(p => `<span class="missing-tag">#${p.number} ${p.name.split(' ')[0]}</span>`).join('')}
                    </div>
                </div>`;
            } else if (currentModalTrasporti.vehicles.length > 0) {
                html += `<p class="all-assigned" style="margin-bottom:1rem;">‚úÖ Tutti i giocatori della lista hanno un posto!</p>`;
            }
            
            // Veicoli
            if (currentModalTrasporti.vehicles.length === 0) {
                html += '<p style="text-align:center; color:#94a3b8; padding:2rem;">Nessun veicolo configurato.</p>';
            } else {
                currentModalTrasporti.vehicles.forEach((v, vIdx) => {
                    const driverName = v.driverName || (v.driver ? getPlayerName(v.driver) : null);
                    const hasDriver = v.driver || v.driverName;
                    const isMyVehicle = String(v.driver) === myId || (v.driverName && v.driverName.includes(`#${myId}`));
                    
                    html += `<div class="vehicle-interactive">
                        <div class="vehicle-interactive-header">
                            <div class="vehicle-interactive-info">
                                <span class="vehicle-icon-large">üöó</span>
                                <div class="vehicle-driver-info">
                                    <h4>${driverName || 'Autista da assegnare'}</h4>
                                    <span>${v.seats} posti totali</span>
                                </div>
                            </div>
                            ${isAdmin ? `<button onclick="removeVehicleModal(${vIdx})" style="background:rgba(239,68,68,0.2);color:#ef4444;border:none;padding:0.5rem 1rem;border-radius:8px;cursor:pointer;">üóëÔ∏è Rimuovi</button>` : ''}
                        </div>
                        
                        <div class="seats-grid">
                            <!-- Posto guidatore -->
                            ${renderDriverSeat(v, vIdx, hasDriver, driverName, myId, amIAssigned)}
                            
                            <!-- Posti passeggeri -->
                            ${renderPassengerSeats(v, vIdx, myId, amIAssigned)}
                        </div>
                        
                        ${v.notes ? `<div class="vehicle-notes"><span class="vehicle-notes-text">üìù ${v.notes}</span></div>` : ''}
                        
                        ${isAdmin ? `
                            <div style="margin-top:1rem;">
                                <input type="text" placeholder="Note veicolo..." value="${v.notes || ''}" 
                                       onchange="updateVehicleNotes(${vIdx}, this.value)"
                                       style="width:100%;padding:0.5rem;border-radius:8px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);color:white;">
                            </div>
                        ` : ''}
                    </div>`;
                });
            }
            
            // Sezione aggiungi veicolo
            html += `<div class="add-my-vehicle-section">
                <h4>‚ûï Aggiungi il tuo veicolo</h4>
                <div class="add-vehicle-form">
                    <select id="newVehicleSeats">
                        ${[4,5,6,7,8,9,10,11].map(n => `<option value="${n}">${n} posti</option>`).join('')}
                    </select>
                    <button onclick="addMyVehicle()">üöó Aggiungo la mia auto</button>
                </div>
            </div>`;
            
            body.innerHTML = html;
        }
        
        function renderDriverSeat(v, vIdx, hasDriver, driverName, myId, amIAssigned) {
            const isMyDriver = String(v.driver) === myId || (v.driverName && v.driverName.includes(`#${myId}`));
            
            if (hasDriver) {
                if (isMyDriver) {
                    return `<div class="seat-slot my-seat" onclick="leaveDriverSeat(${vIdx})">
                        üöó ${driverName}<br><small>(clicca per lasciare)</small>
                    </div>`;
                } else {
                    return `<div class="seat-slot driver-seat">üöó ${driverName}</div>`;
                }
            } else {
                // Posto guidatore libero
                if (amIAssigned) {
                    return `<div class="seat-slot driver-seat driver-free" style="opacity:0.5;cursor:not-allowed;">üöó Libero<br><small>(sei gi√† assegnato)</small></div>`;
                } else {
                    return `<div class="seat-slot driver-seat driver-free" onclick="takeDriverSeat(${vIdx})">üöó Libero<br><small>(clicca per guidare)</small></div>`;
                }
            }
        }
        
        function renderPassengerSeats(v, vIdx, myId, amIAssigned) {
            let html = '';
            const maxPassengers = v.seats - 1;
            const passengers = v.passengers || [];
            const passengerNames = v.passengerNames || [];
            
            for (let i = 0; i < maxPassengers; i++) {
                const passengerId = passengers[i];
                const passengerName = passengerNames[i] || (passengerId ? getPlayerName(passengerId) : null);
                const isMySeat = String(passengerId) === myId || (passengerName && passengerName.includes(`#${myId}`));
                
                if (passengerName) {
                    if (isMySeat) {
                        html += `<div class="seat-slot my-seat" onclick="leavePassengerSeat(${vIdx}, ${i})">
                            ${passengerName}<br><small>(clicca per lasciare)</small>
                        </div>`;
                    } else if (isAdmin) {
                        html += `<div class="seat-slot occupied" onclick="removePassengerAdmin(${vIdx}, ${i})" style="cursor:pointer;">
                            ${passengerName}<br><small>(rimuovi)</small>
                        </div>`;
                    } else {
                        html += `<div class="seat-slot occupied">${passengerName}</div>`;
                    }
                } else {
                    // Posto libero
                    if (amIAssigned) {
                        html += `<div class="seat-slot" style="opacity:0.5;cursor:not-allowed;">Libero</div>`;
                    } else {
                        html += `<div class="seat-slot" onclick="takePassengerSeat(${vIdx}, ${i})">Libero<br><small>(clicca per salire)</small></div>`;
                    }
                }
            }
            
            return html;
        }
        
        async function takeDriverSeat(vIdx) {
            const myId = getCurrentPlayerIdentifier();
            if (isPersonInAnyVehicle(myId)) {
                alert('Sei gi√† assegnato a un veicolo! Lascia prima il posto attuale.');
                return;
            }
            
            const player = playersList.find(p => p.number == myId);
            const myName = player ? `#${player.number} ${player.name}` : `#${myId}`;
            
            currentModalTrasporti.vehicles[vIdx].driver = myId;
            currentModalTrasporti.vehicles[vIdx].driverName = myName;
            
            await saveModalTrasporti();
            renderModalContent();
        }
        
        async function leaveDriverSeat(vIdx) {
            currentModalTrasporti.vehicles[vIdx].driver = '';
            currentModalTrasporti.vehicles[vIdx].driverName = '';
            
            await saveModalTrasporti();
            renderModalContent();
        }
        
        async function takePassengerSeat(vIdx, slotIdx) {
            const myId = getCurrentPlayerIdentifier();
            if (isPersonInAnyVehicle(myId)) {
                alert('Sei gi√† assegnato a un veicolo! Lascia prima il posto attuale.');
                return;
            }
            
            const player = playersList.find(p => p.number == myId);
            const myName = player ? `#${player.number} ${player.name}` : `#${myId}`;
            
            if (!currentModalTrasporti.vehicles[vIdx].passengers) {
                currentModalTrasporti.vehicles[vIdx].passengers = [];
            }
            if (!currentModalTrasporti.vehicles[vIdx].passengerNames) {
                currentModalTrasporti.vehicles[vIdx].passengerNames = [];
            }
            
            currentModalTrasporti.vehicles[vIdx].passengers[slotIdx] = myId;
            currentModalTrasporti.vehicles[vIdx].passengerNames[slotIdx] = myName;
            
            await saveModalTrasporti();
            renderModalContent();
        }
        
        async function leavePassengerSeat(vIdx, slotIdx) {
            currentModalTrasporti.vehicles[vIdx].passengers[slotIdx] = '';
            currentModalTrasporti.vehicles[vIdx].passengerNames[slotIdx] = '';
            
            await saveModalTrasporti();
            renderModalContent();
        }
        
        async function removePassengerAdmin(vIdx, slotIdx) {
            if (!isAdmin) return;
            currentModalTrasporti.vehicles[vIdx].passengers[slotIdx] = '';
            currentModalTrasporti.vehicles[vIdx].passengerNames[slotIdx] = '';
            
            await saveModalTrasporti();
            renderModalContent();
        }
        
        async function removeVehicleModal(vIdx) {
            if (!isAdmin) return;
            if (!confirm('Rimuovere questo veicolo?')) return;
            
            currentModalTrasporti.vehicles.splice(vIdx, 1);
            
            await saveModalTrasporti();
            renderModalContent();
        }
        
        async function updateVehicleNotes(vIdx, notes) {
            if (!isAdmin) return;
            currentModalTrasporti.vehicles[vIdx].notes = notes;
            await saveModalTrasporti();
        }
        
        async function addMyVehicle() {
            const seats = parseInt(document.getElementById('newVehicleSeats').value);
            const myId = getCurrentPlayerIdentifier();
            const player = playersList.find(p => p.number == myId);
            const myName = player ? `#${player.number} ${player.name}` : `#${myId}`;
            
            // Controlla se sono gi√† autista di un altro veicolo
            const alreadyDriver = currentModalTrasporti.vehicles.some(v => 
                String(v.driver) === myId || (v.driverName && v.driverName.includes(`#${myId}`))
            );
            
            if (alreadyDriver) {
                alert('Sei gi√† autista di un altro veicolo!');
                return;
            }
            
            // Se sono passeggero da qualche parte, mi rimuovo
            currentModalTrasporti.vehicles.forEach(v => {
                if (v.passengers) {
                    v.passengers = v.passengers.map((p, i) => {
                        if (String(p) === myId || (v.passengerNames && v.passengerNames[i] && v.passengerNames[i].includes(`#${myId}`))) {
                            if (v.passengerNames) v.passengerNames[i] = '';
                            return '';
                        }
                        return p;
                    });
                }
            });
            
            // Aggiungi nuovo veicolo
            const maxId = currentModalTrasporti.vehicles.reduce((max, v) => Math.max(max, v.id || 0), 0);
            currentModalTrasporti.vehicles.push({
                id: maxId + 1,
                seats: seats,
                driver: myId,
                driverName: myName,
                passengers: [],
                passengerNames: [],
                notes: ''
            });
            
            await saveModalTrasporti();
            renderModalContent();
        }
        
        async function saveModalTrasporti() {
            if (!currentModalMatchId) return;
            
            try {
                await fetch(`${FIREBASE_URL}/trasporti/${currentModalMatchId}.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentModalTrasporti)
                });
            } catch (e) {
                console.error('Errore salvataggio:', e);
                alert('Errore nel salvataggio. Riprova.');
            }
        }
    </script>
</body>
</html>
