
<!-- Tab Bar fissa in basso -->
<nav class="tab-bar">
    <a href="index.html" class="tab-bar-item" title="Home">
        <span>üè†</span>
        <span>Home</span>
    </a>
    <a href="calendario-completo.html" class="tab-bar-item active" title="Calendario">
        <span>üìÖ</span>
        <span>Calendario</span>
    </a>
    <a href="calendario.html" class="tab-bar-item" title="Partite">
        <span>‚öæ</span>
        <span>Partite</span>
    </a>
    <a href="area-personale.html" class="tab-bar-item" title="Profilo">
        <span>üë§</span>
        <span>Profilo</span>
    </a>
</nav>
<style>
    .tab-bar {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        height: 64px;
        background: linear-gradient(135deg, #0a1929 0%, #1a365d 100%);
        display: flex;
        justify-content: space-around;
        align-items: center;
        box-shadow: 0 -2px 16px rgba(0,0,0,0.15);
        z-index: 9999;
        width: 100vw;
        max-width: 100vw;
        min-width: 0;
    }
    .tab-bar-item {
        flex: 1;
        text-align: center;
        color: #94a3b8;
        text-decoration: none;
        font-size: 1.1rem;
        font-weight: 600;
        padding: 0.5rem 0;
        transition: color 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .tab-bar-item span:first-child {
        font-size: 1.5rem;
        margin-bottom: 0.2rem;
    }
    .tab-bar-item span:last-child {
        display: block;
    }
    .tab-bar-item:hover, .tab-bar-item.active {
        color: #f59e0b;
    }
    body { padding-bottom: 70px; }
    html, body {
        height: 100%;
        min-height: 100vh;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    @media (max-width: 420px) {
        .tab-bar {
            height: 48px;
            width: 100vw;
        }
        .tab-bar-item span:last-child {
            font-size: 0.7rem;
        }
        .tab-bar-item span:first-child {
            font-size: 1.2rem;
        }
    }
</style>
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Completo - Lancers Baseball</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1a365d">
<link rel="apple-touch-icon" href="icons/icon-192x192.png"> <meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body>
    <script>
        // Ripristina sessione da localStorage se disponibile
        if (localStorage.getItem('authenticated') === 'true') {
            sessionStorage.setItem('authenticated', 'true');
            const savedPlayer = localStorage.getItem('playerData');
            if (savedPlayer) sessionStorage.setItem('playerData', savedPlayer);
        }
        if (sessionStorage.getItem('authenticated') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>
    <nav class="navbar">
        <div class="nav-brand">
            <div class="baseball-ball logo"></div>
            <span class="team-name">Lancers Baseball</span>
        </div>
        <ul class="nav-links">
            <li><a href="index.html">üè† Home</a></li>
            <li><a href="calendario-completo.html" class="active">üìÖ Calendario</a></li>
            <li><a href="allenamenti.html">üèãÔ∏è Allenamenti</a></li>
            <li><a href="calendario.html">‚öæ Partite</a></li>
            <li><a href="presenze.html">üìã Presenze</a></li>
            <li><a href="documento.html">üìÑ Documento</a></li>
            <li><a href="area-personale.html">üë§ Area Personale</a></li>
        </ul>
        <div class="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </nav>

    <main class="page-content" style="padding-top:1rem; padding-bottom:80px; min-height:100vh;">
        <div class="page-header">
            <h1>üìÖ Calendario 2026</h1>
            <p>Allenamenti, amichevoli e campionato</p>
        </div>

        <div class="ios-calendar" id="iosCal">
            <!-- Navigazione mese -->
            <div class="ios-cal-nav">
                <button class="ios-cal-nav-btn" id="prevMonth" onclick="iosPrevMonth()">&#8249;</button>
                <span class="ios-cal-month" id="calMonthLabel"></span>
                <button class="ios-cal-nav-btn" id="nextMonth" onclick="iosNextMonth()">&#8250;</button>
            </div>
            <!-- Intestazione giorni -->
            <div class="ios-cal-weekdays">
                <div class="ios-cal-weekday">Lun</div>
                <div class="ios-cal-weekday">Mar</div>
                <div class="ios-cal-weekday">Mer</div>
                <div class="ios-cal-weekday">Gio</div>
                <div class="ios-cal-weekday">Ven</div>
                <div class="ios-cal-weekday">Sab</div>
                <div class="ios-cal-weekday">Dom</div>
            </div>
            <!-- Griglia mese -->
            <div class="ios-cal-grid" id="calGrid"></div>
            <!-- Lista eventi del giorno selezionato -->
            <div class="ios-cal-events" id="calEventsList"></div>
        </div>

        <script>
        // === iOS CALENDAR - v46 ===
        const FIREBASE_URL_CAL = 'https://lancersareariservata-default-rtdb.europe-west1.firebasedatabase.app';
        let iosCurrentYear = new Date().getFullYear();
        let iosCurrentMonth = new Date().getMonth();
        let iosSelectedDate = null;
        let calPresenceCache = {};
        let calPresenceLoaded = false;

        const MESI_IT = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
        const MONTH_ABBR_IT = ['GEN','FEB','MAR','APR','MAG','GIU','LUG','AGO','SET','OTT','NOV','DIC'];

        function dateToMatchKey(dateStr) {
            const [y, m, d] = dateStr.split('-').map(Number);
            return pad2(d) + MONTH_ABBR_IT[m-1];
        }

        async function loadCalPresences() {
            if (calPresenceLoaded) return;
            const pd = sessionStorage.getItem('playerData');
            if (!pd) return;
            const player = JSON.parse(pd);
            try {
                const res = await fetch(FIREBASE_URL_CAL + '/presenze/' + player.number + '.json');
                const data = await res.json();
                if (data) {
                    Object.entries(data).forEach(([k, v]) => {
                        calPresenceCache[k.replace(/_/g, '-')] = v.response || v;
                    });
                }
                calPresenceLoaded = true;
            } catch(e) { console.warn('Presenze load error:', e); }
        }

        async function calTogglePresence(date, btnEl) {
            const pd = sessionStorage.getItem('playerData');
            if (!pd) { alert('Devi essere loggato'); return; }
            const player = JSON.parse(pd);
            const current = calPresenceCache[date] || 'yes';
            const newStatus = current === 'no' ? 'yes' : 'no';
            btnEl.disabled = true;
            btnEl.textContent = '‚è≥';
            try {
                await fetch(FIREBASE_URL_CAL + '/presenze/' + player.number + '/' + date.replace(/-/g,'_') + '.json', {
                    method: 'PUT',
                    body: JSON.stringify({ response: newStatus, timestamp: new Date().toISOString() })
                });
                calPresenceCache[date] = newStatus;
                const calMap = buildCalEventMap();
                renderDayEvents(calMap, date);
            } catch(e) {
                console.error(e);
                btnEl.disabled = false;
                btnEl.textContent = current === 'no' ? 'Torna presente' : 'Segna assenza';
            }
        }

        function buildCalEventMap() {
            const map = {};
            function addToMap(dateStr, ev) {
                if (!map[dateStr]) map[dateStr] = [];
                map[dateStr].push(ev);
            }
            if (typeof allEvents !== 'undefined') {
                allEvents.forEach(e => addToMap(e.date, e));
            }
            if (typeof wednesdayTrainings !== 'undefined') {
                Object.entries(wednesdayTrainings).forEach(([d, t]) => {
                    const tipo = t.tipo || '';
                    let subtype = 'wednesday';
                    if (tipo.toUpperCase().includes('BATTUTA')) subtype = 'battuta';
                    else if (tipo.toUpperCase().includes('DIFESA')) subtype = 'difesa';
                    addToMap(d, { date: d, type: subtype, title: tipo, time: 'üéØ Allenamento specifico', tag: 'üí™ ' + tipo, isWednesday: true, giocatori: t.giocatori });
                });
            }
            return map;
        }

        function typeToDotClass(type) {
            const m = { 'match-home':'dot-match-home','home':'dot-match-home','match-away':'dot-match-away','away':'dot-match-away','friendly':'dot-friendly','event':'dot-event','autonomous':'dot-autonomous','battuta':'dot-battuta','difesa':'dot-difesa','specific':'dot-specific','wednesday':'dot-wednesday','training':'dot-training' };
            return m[type] || 'dot-training';
        }

        function typeToColor(type) {
            const m = { 'match-home':'#22c55e','home':'#22c55e','match-away':'#60a5fa','away':'#60a5fa','friendly':'#dc2626','event':'#eab308','autonomous':'#a78bfa','battuta':'#f59e0b','difesa':'#22c55e','specific':'#14b8a6','wednesday':'#14b8a6','training':'#3b82f6' };
            return m[type] || '#3b82f6';
        }

        function typeToLabel(type) {
            const m = { 'match-home':'üè† Partita Casa','match-away':'‚úàÔ∏è Trasferta','friendly':'ü§ù Amichevole','event':'üé™ Evento','autonomous':'üí™ Autonomo','battuta':'üèè Battuta','difesa':'üß§ Difesa','specific':'üéØ Specifico','wednesday':'üéØ Mercoled√¨','training':'üèãÔ∏è Allenamento' };
            return m[type] || 'üìÖ Evento';
        }

        function pad2(n) { return String(n).padStart(2, '0'); }

        function renderIosCalendar() {
            const calMap = buildCalEventMap();
            const year = iosCurrentYear;
            const month = iosCurrentMonth;
            document.getElementById('calMonthLabel').textContent = MESI_IT[month] + ' ' + year;

            const firstDay = new Date(year, month, 1).getDay();
            const startOffset = (firstDay === 0) ? 6 : firstDay - 1;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            const today = new Date();
            const todayStr = year + '-' + pad2(today.getMonth()+1) + '-' + pad2(today.getDate());

            const grid = document.getElementById('calGrid');
            grid.innerHTML = '';

            for (let i = 0; i < startOffset; i++) {
                const d = daysInPrevMonth - startOffset + 1 + i;
                const cell = document.createElement('div');
                cell.className = 'ios-cal-day other-month';
                const prevM = month === 0 ? 12 : month;
                const prevY = month === 0 ? year - 1 : year;
                const dateStr = prevY + '-' + pad2(prevM) + '-' + pad2(d);
                cell.innerHTML = '<span class="day-num">' + d + '</span>';
                const dots = renderDots(calMap, dateStr);
                if (dots) cell.appendChild(dots);
                cell.onclick = () => iosSelectDay(dateStr);
                grid.appendChild(cell);
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = year + '-' + pad2(month + 1) + '-' + pad2(d);
                const cell = document.createElement('div');
                cell.className = 'ios-cal-day';
                if (dateStr === todayStr) cell.classList.add('today');
                if (dateStr === iosSelectedDate) cell.classList.add('selected');
                cell.id = 'cal-day-' + dateStr;
                const numSpan = document.createElement('span');
                numSpan.className = 'day-num';
                numSpan.textContent = d;
                cell.appendChild(numSpan);
                const dots = renderDots(calMap, dateStr);
                if (dots) cell.appendChild(dots);
                cell.onclick = () => iosSelectDay(dateStr);
                grid.appendChild(cell);
            }

            const totalCells = startOffset + daysInMonth;
            const remaining = (7 - (totalCells % 7)) % 7;
            for (let d = 1; d <= remaining; d++) {
                const nextM = month === 11 ? 1 : month + 2;
                const nextY = month === 11 ? year + 1 : year;
                const dateStr = nextY + '-' + pad2(nextM) + '-' + pad2(d);
                const cell = document.createElement('div');
                cell.className = 'ios-cal-day other-month';
                cell.innerHTML = '<span class="day-num">' + d + '</span>';
                cell.onclick = () => iosSelectDay(dateStr);
                grid.appendChild(cell);
            }

            if (iosSelectedDate) {
                renderDayEvents(calMap, iosSelectedDate);
            } else {
                renderUpcomingEvents(calMap);
            }
        }

        function renderDots(calMap, dateStr) {
            const evs = calMap[dateStr];
            if (!evs || evs.length === 0) return null;
            const dotsDiv = document.createElement('div');
            dotsDiv.className = 'day-dots';
            evs.slice(0, 4).forEach(e => {
                const dot = document.createElement('div');
                dot.className = 'day-dot ' + typeToDotClass(e.type);
                dotsDiv.appendChild(dot);
            });
            return dotsDiv;
        }

        function iosSelectDay(dateStr) {
            iosSelectedDate = dateStr;
            document.querySelectorAll('.ios-cal-day.selected').forEach(el => el.classList.remove('selected'));
            const el = document.getElementById('cal-day-' + dateStr);
            if (el) el.classList.add('selected');
            const calMap = buildCalEventMap();
            renderDayEvents(calMap, dateStr);
        }

        function iosPrevMonth() {
            if (iosCurrentMonth === 0) { iosCurrentMonth = 11; iosCurrentYear--; }
            else iosCurrentMonth--;
            renderIosCalendar();
        }
        function iosNextMonth() {
            if (iosCurrentMonth === 11) { iosCurrentMonth = 0; iosCurrentYear++; }
            else iosCurrentMonth++;
            renderIosCalendar();
        }

        function formatItalianDate(dateStr) {
            const [y, m, d] = dateStr.split('-').map(Number);
            const days = ['Dom','Lun','Mar','Mer','Gio','Ven','Sab'];
            const months = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
            const dow = new Date(y, m-1, d).getDay();
            return days[dow] + ' ' + d + ' ' + months[m-1];
        }

        function renderDayEvents(calMap, dateStr) {
            const evs = calMap[dateStr] || [];
            const container = document.getElementById('calEventsList');
            const dateLabel = formatItalianDate(dateStr);

            if (evs.length === 0) {
                container.innerHTML = '<div class="ios-cal-events-header">' + dateLabel + '</div><div class="cal-empty-day"><span>üò¥</span><p>Nessun evento</p></div>';
                return;
            }

            let html = '<div class="ios-cal-events-header">' + dateLabel + '</div>';

            evs.forEach(function(e) {
                const color = typeToColor(e.type);
                const label = typeToLabel(e.type);
                const presence = calPresenceCache[dateStr] || 'yes';
                const isAbsent = presence === 'no';

                // Match info lookup
                const matchKey = dateToMatchKey(dateStr);
                const mInfo = (typeof matchesInfo !== 'undefined' && matchesInfo[matchKey]) ? matchesInfo[matchKey] : null;

                // Wednesday giocatori lookup
                const playerData = JSON.parse(sessionStorage.getItem('playerData') || '{}');
                const isMyWednesday = e.isWednesday && e.giocatori && e.giocatori.includes(playerData.number);

                html += '<div class="cal-event-card cal-ev-' + (e.type||'training') + '">';
                html += '<div class="cal-ev-stripe" style="background:' + color + '"></div>';
                html += '<div class="cal-ev-body">';

                // Top row
                html += '<div class="cal-ev-top">';
                html += '<div class="cal-ev-title-wrap">';
                html += '<span class="cal-ev-title">' + (e.title||'Evento') + '</span>';
                if (e.time) html += '<span class="cal-ev-time">' + e.time + '</span>';
                html += '</div>';
                html += '<span class="cal-ev-badge" style="background:' + color + '22;color:' + color + ';border:1px solid ' + color + '44">' + label + '</span>';
                html += '</div>';

                // Match details block
                if (mInfo) {
                    html += '<div class="cal-ev-details">';
                    html += '<div class="cal-ev-detail-row"><span>üïê</span><span>Ritrovo: <strong>' + mInfo.ritrovo + '</strong></span></div>';
                    html += '<div class="cal-ev-detail-row"><span>üìç</span><span>' + mInfo.luogo + '</span></div>';
                    if (mInfo.note) html += '<div class="cal-ev-detail-row"><span>üìù</span><span>' + mInfo.note + '</span></div>';
                    if (mInfo.maps) html += '<a href="' + mInfo.maps + '" target="_blank" class="cal-ev-maps-btn">üìç Apri Google Maps</a>';
                    html += '</div>';
                }

                // Wednesday specifics
                if (isMyWednesday) {
                    html += '<div class="cal-ev-mine-badge">‚≠ê Il tuo mercoled√¨ extra</div>';
                }

                // Presence row
                html += '<div class="cal-ev-presence">';
                html += '<span class="cal-pres-badge ' + (isAbsent ? 'absent' : 'present') + '">';
                html += isAbsent ? '‚ùå Assente' : '‚úÖ Presente';
                html += '</span>';
                html += '<button class="cal-toggle-btn" onclick="calTogglePresence(\'' + dateStr + '\', this)">';
                html += isAbsent ? 'Torna presente' : 'Segna assenza';
                html += '</button>';
                html += '</div>';

                html += '</div>'; // cal-ev-body
                html += '</div>'; // cal-event-card
            });

            container.innerHTML = html;
        }

        function renderUpcomingEvents(calMap) {
            const today = new Date();
            today.setHours(0,0,0,0);
            const container = document.getElementById('calEventsList');
            const upcoming = [];
            Object.entries(calMap).sort((a,b) => a[0].localeCompare(b[0])).forEach(([d, evs]) => {
                const [y, m, day] = d.split('-').map(Number);
                const dt = new Date(y, m-1, day);
                if (dt >= today && upcoming.length < 8) {
                    evs.forEach(e => { if (upcoming.length < 8) upcoming.push(Object.assign({}, e, {date: d})); });
                }
            });

            if (upcoming.length === 0) {
                container.innerHTML = '<div class="ios-cal-events-header">Prossimi eventi</div><div class="cal-empty-day"><span>üìÖ</span><p>Nessun evento in programma</p></div>';
                return;
            }

            let html = '<div class="ios-cal-events-header">Prossimi eventi üìÖ</div>';
            upcoming.forEach(function(e) {
                const color = typeToColor(e.type);
                const label = typeToLabel(e.type);
                const dateLabel = formatItalianDate(e.date);
                const presence = calPresenceCache[e.date] || 'yes';
                const isAbsent = presence === 'no';

                html += '<div class="cal-event-card cal-ev-' + (e.type||'training') + '" onclick="iosSelectDay(\'' + e.date + '\')" style="cursor:pointer">';
                html += '<div class="cal-ev-stripe" style="background:' + color + '"></div>';
                html += '<div class="cal-ev-body">';
                html += '<div class="cal-ev-top">';
                html += '<div class="cal-ev-title-wrap">';
                html += '<span class="cal-ev-title">' + (e.title||'Evento') + '</span>';
                html += '<span class="cal-ev-time">' + dateLabel + (e.time ? ' ¬∑ ' + e.time : '') + '</span>';
                html += '</div>';
                html += '<span class="cal-ev-badge" style="background:' + color + '22;color:' + color + ';border:1px solid ' + color + '44">' + label + '</span>';
                html += '</div>';
                // Presence badge inline
                html += '<div class="cal-ev-presence">';
                html += '<span class="cal-pres-badge ' + (isAbsent ? 'absent' : 'present') + '">' + (isAbsent ? '‚ùå Assente' : '‚úÖ Presente') + '</span>';
                html += '<button class="cal-toggle-btn" onclick="event.stopPropagation();calTogglePresence(\'' + e.date + '\', this)">' + (isAbsent ? 'Torna presente' : 'Segna assenza') + '</button>';
                html += '</div>';
                html += '</div></div>';
            });
            container.innerHTML = html;
        }

        window.addEventListener('DOMContentLoaded', async () => {
            const tod = new Date();
            iosCurrentYear = tod.getFullYear();
            iosCurrentMonth = tod.getMonth();
            await loadCalPresences();
            renderIosCalendar();
        });
        </script>
    </main>

    <!-- Tab Bar fissa in basso -->
    <nav class="tab-bar">
        <a href="index.html" class="tab-bar-item" title="Home">
            <span>üè†</span>
            <span>Home</span>
        </a>
        <a href="calendario-completo.html" class="tab-bar-item active" title="Calendario">
            <span>üìÖ</span>
            <span>Calendario</span>
        </a>
        <a href="calendario.html" class="tab-bar-item" title="Partite">
            <span>‚öæ</span>
            <span>Partite</span>
        </a>
        <a href="area-personale.html" class="tab-bar-item" title="Profilo">
            <span>üë§</span>
            <span>Profilo</span>
        </a>
    </nav>
    <style>
        .tab-bar {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            height: 64px;
            background: linear-gradient(135deg, #0a1929 0%, #1a365d 100%);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 16px rgba(0,0,0,0.15);
            z-index: 9999;
            width: 100vw;
            max-width: 100vw;
            min-width: 0;
        }
        .tab-bar-item {
            flex: 1;
            text-align: center;
            color: #94a3b8;
            text-decoration: none;
            font-size: 1.1rem;
            font-weight: 600;
            padding: 0.5rem 0;
            transition: color 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .tab-bar-item span:first-child {
            font-size: 1.5rem;
            margin-bottom: 0.2rem;
        }
        .tab-bar-item span:last-child {
            display: block;
        }
        .tab-bar-item:hover, .tab-bar-item.active {
            color: #f59e0b;
        }
        body { padding-bottom: 70px; }
        html, body {
            height: 100%;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        @media (max-width: 420px) {
            .tab-bar {
                height: 48px;
                width: 100vw;
            }
            .tab-bar-item span:last-child {
                font-size: 0.7rem;
            }
            .tab-bar-item span:first-child {
                font-size: 1.2rem;
            }
        }
    </style>

    <footer style="padding-bottom: 120px; margin-bottom: 0;">
        <p>‚öæ ¬© 2026 Lancers Baseball Club - Serie B Federazione Italiana Baseball Softball</p>
        <p class="footer-motto">"Play Hard, Play Fair, Play Together" üèÜ</p>
        <div style="display: flex; justify-content: center;">
            <button id="logoutBtn" class="footer-logout-btn">üö™ Logout</button>
        </div>
    </footer>

    <!-- Modal Info Partita -->
    <div id="matchInfoModal" class="match-info-modal">
        <div class="match-info-modal-content">
            <div class="match-info-modal-header">
                <h2 id="matchInfoTitle">üìã Dettagli Partita</h2>
                <button class="match-info-modal-close" onclick="closeMatchInfoModal()">‚úï</button>
            </div>
            <div class="match-info-modal-body" id="matchInfoBody">
                <!-- Contenuto dinamico -->
            </div>
        </div>
    </div>

    <!-- Modal Gestione Trasporti -->
    <div id="trasportiModal" class="trasporti-modal">
        <div class="trasporti-modal-content">
            <div class="trasporti-modal-header">
                <h2 id="modalMatchTitle">üöó Gestione Trasporti</h2>
                <button class="trasporti-modal-close" onclick="closeTrasportiModal()">‚úï</button>
            </div>
            <div class="trasporti-modal-body" id="modalBody">
                <!-- Contenuto dinamico -->
            </div>
        </div>
    </div>

    <script src="script.js?v=47"></script>
    <script>
        // Database info partite
        const matchesInfo = {
            // AMICHEVOLI MARZO
            '01MAR': { opponent: 'Amichevole Interna', type: 'casa', time: '10:00', ritrovo: '09:30 al campo', luogo: 'Campo Lancers', note: 'Amichevole interna preparazione stagione' },
            '08MAR': { opponent: 'Castenaso/Phoenix', type: 'casa', time: '10:00', ritrovo: '09:30 al campo', luogo: 'Campo Lancers', note: 'Amichevole pre-stagione' },
            '14MAR': { opponent: 'Fortitudo Bologna', type: 'trasferta', time: '11:00', ritrovo: 'Da definire', luogo: 'Stadio Gianni Falchi, Bologna', maps: 'https://maps.google.com/?q=Stadio+Gianni+Falchi+Bologna' },
            '22MAR': { opponent: 'Fiorentina', type: 'trasferta', time: '11:00', ritrovo: 'Da definire', luogo: 'Campo Fiorentina Baseball, Firenze', maps: 'https://maps.google.com/?q=Fiorentina+Baseball+Firenze' },
            '29MAR': { opponent: 'A.S.D BSC Arezzo', type: 'casa', time: '11:00', ritrovo: '10:00 al campo', luogo: 'Campo Lancers' },
            // APRILE
            '12APR': { opponent: 'Health & Performance S.S.D', type: 'trasferta', time: '11:00', ritrovo: 'Da definire', luogo: 'Campo Health & Performance', maps: 'https://maps.google.com/?q=Health+Performance+Baseball' },
            '19APR': { opponent: 'Livorno 1940 Baseball', type: 'trasferta', time: '11:00', ritrovo: 'Da definire', luogo: 'Campo Livorno 1940', maps: 'https://maps.google.com/?q=Livorno+Baseball' },
            '26APR': { opponent: 'Longbridge 2000 B.C', type: 'casa', time: '11:00', ritrovo: '10:00 al campo', luogo: 'Campo Lancers' },
            // MAGGIO
            '03MAG': { opponent: 'Colorno B.C.', type: 'trasferta', time: '11:00', ritrovo: 'Da definire', luogo: 'Campo Colorno B.C.', maps: 'https://maps.google.com/?q=Colorno+Baseball+Parma' },
            '10MAG': { opponent: 'A.S.D BSC Arezzo', type: 'casa', time: '11:00', ritrovo: '10:00 al campo', luogo: 'Campo Lancers' },
            '17MAG': { opponent: 'Cali Roma XII', type: 'casa', time: '11:00', ritrovo: '10:00 al campo', luogo: 'Campo Lancers' },
            '30MAG': { opponent: 'Padule Baseball A.S.D', type: 'trasferta', time: '15:00', ritrovo: 'Da definire', luogo: 'Campo Padule Baseball', note: 'Sabato', maps: 'https://maps.google.com/?q=Padule+Baseball' },
            // GIUGNO
            '07GIU': { opponent: 'Health & Performance S.S.D', type: 'casa', time: '11:00', ritrovo: '10:00 al campo', luogo: 'Campo Lancers', note: 'Ritorno campionato' },
            '14GIU': { opponent: 'Livorno 1940 Baseball', type: 'casa', time: '11:00', ritrovo: '10:00 al campo', luogo: 'Campo Lancers' },
            '21GIU': { opponent: 'Longbridge 2000 B.C', type: 'trasferta', time: '11:00', ritrovo: 'Da definire', luogo: 'Campo Longbridge 2000', maps: 'https://maps.google.com/?q=Longbridge+2000+Baseball' },
            '28GIU': { opponent: 'Colorno B.C.', type: 'casa', time: '11:00', ritrovo: '10:00 al campo', luogo: 'Campo Lancers' },
            // LUGLIO
            '05LUG': { opponent: 'A.S.D BSC Arezzo', type: 'trasferta', time: '11:00', ritrovo: 'Da definire', luogo: 'Campo BSC Arezzo', maps: 'https://maps.google.com/?q=BSC+Arezzo+Baseball' },
            '12LUG': { opponent: 'Cali Roma XII', type: 'trasferta', time: '11:00', ritrovo: 'Da definire', luogo: 'Campo Cali Roma XII', maps: 'https://maps.google.com/?q=Cali+Roma+Baseball' },
            '26LUG': { opponent: 'Padule Baseball A.S.D', type: 'casa', time: '11:00', ritrovo: '10:00 al campo', luogo: 'Campo Lancers', note: 'Ritorno' }
        };
        
        // Aggiungi bottoni info alle card partite
        document.addEventListener('DOMContentLoaded', function() {
            addMatchInfoButtons();
            loadTrasportiForCalendar();
        });
        
        function addMatchInfoButtons() {
            const cards = document.querySelectorAll('.match-card');
            cards.forEach(card => {
                const matchInfo = card.querySelector('.match-info');
                const opponent = matchInfo?.querySelector('.opponent')?.textContent || '';
                const matchTime = matchInfo?.querySelector('.match-time')?.textContent || '';
                
                // Solo per partite (contiene vs, @, ‚úàÔ∏è, üè†)
                if (!opponent.includes('vs') && !opponent.includes('@') && !matchTime.includes('‚úàÔ∏è') && !matchTime.includes('üè†')) return;
                
                const dateSpan = card.querySelector('.match-date');
                const day = dateSpan?.querySelector('.day')?.textContent;
                const month = dateSpan?.querySelector('.month')?.textContent;
                if (!day || !month) return;
                
                const matchKey = `${day}${month}`;
                if (!matchesInfo[matchKey]) return;
                
                // Controlla se esiste gi√† il bottone
                if (matchInfo.querySelector('.match-info-btn')) return;
                
                const btn = document.createElement('button');
                btn.className = 'match-info-btn';
                btn.innerHTML = '‚ÑπÔ∏è Info';
                btn.onclick = (e) => {
                    e.stopPropagation();
                    openMatchInfoModal(matchKey);
                };
                matchInfo.appendChild(btn);
            });
        }
        
        function openMatchInfoModal(matchKey) {
            const info = matchesInfo[matchKey];
            if (!info) return;
            
            document.getElementById('matchInfoTitle').textContent = `üìã ${info.opponent}`;
            
            let html = `
                <div class="match-detail-row"><strong>üèüÔ∏è Tipo:</strong><span>${info.type === 'casa' ? 'üè† Casa' : '‚úàÔ∏è Trasferta'}</span></div>
                <div class="match-detail-row"><strong>‚öæ Orario:</strong><span>${info.time}</span></div>
                <div class="match-detail-row"><strong>üïê Ritrovo:</strong><span>${info.ritrovo}</span></div>
                <div class="match-detail-row"><strong>üìç Luogo:</strong><span>${info.luogo}</span></div>
            `;
            if (info.note) {
                html += `<div class="match-detail-row"><strong>üìù Note:</strong><span>${info.note}</span></div>`;
            }
            if (info.maps) {
                html += `<a href="${info.maps}" target="_blank" class="match-map-btn">üìç Apri Maps</a>`;
            }
            
            document.getElementById('matchInfoBody').innerHTML = html;
            document.getElementById('matchInfoModal').classList.add('open');
        }
        
        function closeMatchInfoModal() {
            document.getElementById('matchInfoModal').classList.remove('open');
        }
        
        // Lista giocatori per mapping
        const playersList = [
            { number: 0, name: 'Niccol√≤ Bucci' },
            { number: 1, name: 'Alessandro Ferrini' },
            { number: 3, name: 'Ettore Della Nave' },
            { number: 4, name: 'Giovanni G. Beudean' },
            { number: 6, name: 'Simone Geri' },
            { number: 7, name: 'Silvano Albano' },
            { number: 8, name: 'Tommaso Panichi' },
            { number: 12, name: 'Francesco Grassi' },
            { number: 14, name: 'Leonardo Scarpulla' },
            { number: 19, name: 'Simone Baratella' },
            { number: 22, name: 'Giuseppe G. Grado' },
            { number: 24, name: 'Guido Nannucci' },
            { number: 25, name: 'Lorenzo Scarpulla' },
            { number: 32, name: 'Filippo Anichini' },
            { number: 38, name: 'Antonio Parrini' },
            { number: 59, name: 'Lapo Biondi' },
            { number: 77, name: 'Cosimo Rinaldi' },
            { number: 89, name: 'Daniele Silvestri' },
            { number: 90, name: 'Alessandro Rrethatori' },
            { number: 98, name: 'Francesco Paperini' },
            { number: 99, name: 'Victor Vergara' }
        ];
        
        function getPlayerName(num) {
            const p = playersList.find(pl => pl.number == num);
            return p ? p.name : `#${num}`;
        }
        
        // Mappa date partite trasferta
        const matchDateMap = {
            '2026-03-14': { day: '14', month: 'MAR' },
            '2026-03-22': { day: '22', month: 'MAR' },
            '2026-04-04': { day: '04', month: 'APR' },
            '2026-04-19': { day: '19', month: 'APR' },
            '2026-05-03': { day: '03', month: 'MAG' },
            '2026-05-30': { day: '30', month: 'MAG' },
            '2026-06-21': { day: '21', month: 'GIU' },
            '2026-07-05': { day: '05', month: 'LUG' },
            '2026-07-12': { day: '12', month: 'LUG' }
        };
        
        const FIREBASE_URL = 'https://lancersareariservata-default-rtdb.europe-west1.firebasedatabase.app';
        let currentModalMatchId = null;
        let currentModalTrasporti = { vehicles: [] };
        const currentPlayerData = JSON.parse(sessionStorage.getItem('playerData') || '{}');
        const isAdmin = [25, 19, 38, 6, 'ADMIN'].includes(currentPlayerData.number);
        
        async function loadTrasportiForCalendar() {
            try {
                const response = await fetch(`${FIREBASE_URL}/trasporti.json`);
                const allTrasporti = await response.json() || {};
                
                // Trova card trasferta nel calendario completo
                const cards = document.querySelectorAll('.match-card');
                cards.forEach(card => {
                    // Controlla se √® una trasferta (contiene ‚úàÔ∏è o "@ ")
                    const matchInfo = card.querySelector('.match-info');
                    const opponent = matchInfo?.querySelector('.opponent')?.textContent || '';
                    const matchTime = matchInfo?.querySelector('.match-time')?.textContent || '';
                    
                    if (!matchTime.includes('‚úàÔ∏è') && !opponent.includes('@')) return;
                    
                    const dateSpan = card.querySelector('.match-date');
                    const day = dateSpan?.querySelector('.day')?.textContent;
                    const month = dateSpan?.querySelector('.month')?.textContent;
                    if (!day || !month) return;
                    
                    // Trova matchId corrispondente
                    let matchId = null;
                    for (const [id, dateInfo] of Object.entries(matchDateMap)) {
                        if (dateInfo.day === day && dateInfo.month === month) {
                            matchId = id;
                            break;
                        }
                    }
                    
                    if (!matchId) return;
                    
                    // Aggiungi sezione trasporti se non esiste
                    if (!matchInfo.querySelector('.trasporti-mini')) {
                        const data = allTrasporti[matchId];
                        if (data && data.vehicles && data.vehicles.length > 0) {
                            const totalPeople = data.vehicles.reduce((sum, v) => {
                                let c = (v.driver || v.driverName) ? 1 : 0;
                                c += (v.passengerNames || v.passengers || []).filter(p => p && p.trim()).length;
                                return sum + c;
                            }, 0);
                            const totalSeats = data.vehicles.reduce((sum, v) => sum + v.seats, 0);
                            
                            matchInfo.insertAdjacentHTML('beforeend', `
                                <div class="trasporti-mini" style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px dashed rgba(0,0,0,0.1);">
                                    <span style="font-size: 0.8rem;">üöó ${data.vehicles.length} veicoli ‚Ä¢ ${totalPeople}/${totalSeats} posti</span>
                                    <button onclick="event.stopPropagation(); openTrasportiModal('${matchId}')" 
                                            style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        Gestisci
                                    </button>
                                </div>
                            `);
                        } else {
                            matchInfo.insertAdjacentHTML('beforeend', `
                                <div class="trasporti-mini" style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px dashed rgba(0,0,0,0.1);">
                                    <span style="font-size: 0.8rem; color: #94a3b8;">üöó Nessun veicolo</span>
                                    <button onclick="event.stopPropagation(); openTrasportiModal('${matchId}')" 
                                            style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        Aggiungi
                                    </button>
                                </div>
                            `);
                        }
                    }
                });
            } catch (e) {
                console.error('Errore caricamento trasporti:', e);
            }
        }
        
        function openTrasportiModal(matchId) {
            currentModalMatchId = matchId;
            document.getElementById('trasportiModal').classList.add('open');
            document.getElementById('modalMatchTitle').textContent = 'üöó Trasporti - ' + getMatchName(matchId);
            loadModalTrasporti(matchId);
        }
        
        function closeTrasportiModal() {
            document.getElementById('trasportiModal').classList.remove('open');
            currentModalMatchId = null;
            location.reload(); // Ricarica per aggiornare i dati
        }
        
        function getMatchName(matchId) {
            const names = {
                '2026-03-14': 'Fortitudo Bologna',
                '2026-03-22': 'Fiorentina',
                '2026-04-04': 'Health & Performance',
                '2026-04-19': 'Livorno 1940',
                '2026-05-03': 'Colorno B.C.',
                '2026-05-30': 'Padule Baseball',
                '2026-06-21': 'Longbridge 2000',
                '2026-07-05': 'BSC Arezzo',
                '2026-07-12': 'Cali Roma XII'
            };
            return names[matchId] || matchId;
        }
        
        async function loadModalTrasporti(matchId) {
            const body = document.getElementById('modalBody');
            body.innerHTML = '<p style="text-align:center; color:#94a3b8;">‚è≥ Caricamento...</p>';
            
            try {
                const response = await fetch(`${FIREBASE_URL}/trasporti/${matchId}.json`);
                const data = await response.json();
                currentModalTrasporti = data && data.vehicles ? data : { vehicles: [] };
                renderModalContent();
            } catch (e) {
                console.error('Errore:', e);
                currentModalTrasporti = { vehicles: [] };
                renderModalContent();
            }
        }
        
        function getCurrentPlayerIdentifier() {
            return String(currentPlayerData.number);
        }
        
        function isPersonInAnyVehicle(personId) {
            for (const v of currentModalTrasporti.vehicles) {
                if (String(v.driver) === String(personId)) return true;
                if (v.driverName && v.driverName.includes(`#${personId}`)) return true;
                if (v.passengers) {
                    for (let i = 0; i < v.passengers.length; i++) {
                        if (String(v.passengers[i]) === String(personId)) return true;
                        if (v.passengerNames && v.passengerNames[i] && v.passengerNames[i].includes(`#${personId}`)) return true;
                    }
                }
            }
            return false;
        }
        
        function renderModalContent() {
            const body = document.getElementById('modalBody');
            const myId = getCurrentPlayerIdentifier();
            const amIAssigned = isPersonInAnyVehicle(myId);
            
            const assignedPeople = new Set();
            currentModalTrasporti.vehicles.forEach(v => {
                if (v.driver) assignedPeople.add(String(v.driver));
                (v.passengers || []).forEach(p => { if (p) assignedPeople.add(String(p)); });
            });
            
            const missingPlayers = playersList.filter(p => !assignedPeople.has(String(p.number)));
            
            let html = '';
            
            if (missingPlayers.length > 0) {
                html += `<div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                    <h4 style="color: #ef4444; margin: 0 0 0.5rem 0; font-size: 0.95rem;">‚ö†Ô∏è Senza posto (${missingPlayers.length}):</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${missingPlayers.map(p => `<span style="background: rgba(239, 68, 68, 0.2); color: #fca5a5; padding: 0.25rem 0.6rem; border-radius: 20px; font-size: 0.8rem;">#${p.number} ${p.name.split(' ')[0]}</span>`).join('')}
                    </div>
                </div>`;
            } else if (currentModalTrasporti.vehicles.length > 0) {
                html += `<p style="color: #22c55e; margin-bottom:1rem;">‚úÖ Tutti i giocatori della lista hanno un posto!</p>`;
            }
            
            if (currentModalTrasporti.vehicles.length === 0) {
                html += '<p style="text-align:center; color:#94a3b8; padding:2rem;">Nessun veicolo configurato.</p>';
            } else {
                currentModalTrasporti.vehicles.forEach((v, vIdx) => {
                    const driverName = v.driverName || (v.driver ? getPlayerName(v.driver) : null);
                    const hasDriver = v.driver || v.driverName;
                    const isMyDriver = String(v.driver) === myId || (v.driverName && v.driverName.includes(`#${myId}`));
                    
                    html += `<div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="font-size: 1.5rem;">üöó</span>
                                <div>
                                    <h4 style="margin: 0; color: white; font-size: 1rem;">${driverName || 'Autista da assegnare'}</h4>
                                    <span style="color: #94a3b8; font-size: 0.85rem;">${v.seats} posti totali</span>
                                </div>
                            </div>
                            ${isAdmin ? `<button onclick="removeVehicleModal(${vIdx})" style="background:rgba(239,68,68,0.2);color:#ef4444;border:none;padding:0.5rem 1rem;border-radius:8px;cursor:pointer;">üóëÔ∏è</button>` : ''}
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 0.5rem;">
                            ${renderDriverSeatCC(v, vIdx, hasDriver, driverName, myId, amIAssigned)}
                            ${renderPassengerSeatsCC(v, vIdx, myId, amIAssigned)}
                        </div>
                        
                        ${v.notes ? `<div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.1);"><span style="color: #94a3b8; font-size: 0.85rem; font-style: italic;">üìù ${v.notes}</span></div>` : ''}
                    </div>`;
                });
            }
            
            html += `<div style="background: rgba(34, 197, 94, 0.1); border: 2px dashed rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 1.5rem; text-align: center; margin-top: 1rem;">
                <h4 style="color: #22c55e; margin: 0 0 1rem 0;">‚ûï Aggiungi il tuo veicolo</h4>
                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <select id="newVehicleSeats" style="padding: 0.75rem 1rem; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: white;">
                        ${[4,5,6,7,8,9,10,11].map(n => `<option value="${n}">${n} posti</option>`).join('')}
                    </select>
                    <button onclick="addMyVehicle()" style="padding: 0.75rem 1rem; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">üöó Aggiungo la mia auto</button>
                </div>
            </div>`;
            
            body.innerHTML = html;
        }
        
        function renderDriverSeatCC(v, vIdx, hasDriver, driverName, myId, amIAssigned) {
            const isMyDriver = String(v.driver) === myId || (v.driverName && v.driverName.includes(`#${myId}`));
            const baseStyle = 'padding: 0.6rem; text-align: center; border-radius: 8px; font-size: 0.85rem;';
            
            if (hasDriver) {
                if (isMyDriver) {
                    return `<div style="${baseStyle} background: rgba(234, 179, 8, 0.2); border: 2px solid rgba(234, 179, 8, 0.5); color: #eab308; cursor: pointer;" onclick="leaveDriverSeat(${vIdx})">
                        üöó ${driverName}<br><small>(clicca per lasciare)</small>
                    </div>`;
                } else {
                    return `<div style="${baseStyle} background: rgba(59, 130, 246, 0.2); border: 2px solid rgba(59, 130, 246, 0.5); color: #3b82f6;">üöó ${driverName}</div>`;
                }
            } else {
                if (amIAssigned) {
                    return `<div style="${baseStyle} background: rgba(0,0,0,0.3); border: 2px dashed rgba(59, 130, 246, 0.3); color: #94a3b8; opacity: 0.5;">üöó Libero</div>`;
                } else {
                    return `<div style="${baseStyle} background: rgba(0,0,0,0.3); border: 2px dashed rgba(59, 130, 246, 0.3); color: #94a3b8; cursor: pointer;" onclick="takeDriverSeat(${vIdx})">üöó Libero<br><small>(clicca per guidare)</small></div>`;
                }
            }
        }
        
        function renderPassengerSeatsCC(v, vIdx, myId, amIAssigned) {
            let html = '';
            const maxPassengers = v.seats - 1;
            const passengers = v.passengers || [];
            const passengerNames = v.passengerNames || [];
            const baseStyle = 'padding: 0.6rem; text-align: center; border-radius: 8px; font-size: 0.85rem;';
            
            for (let i = 0; i < maxPassengers; i++) {
                const passengerId = passengers[i];
                const passengerName = passengerNames[i] || (passengerId ? getPlayerName(passengerId) : null);
                const isMySeat = String(passengerId) === myId || (passengerName && passengerName.includes(`#${myId}`));
                
                if (passengerName) {
                    if (isMySeat) {
                        html += `<div style="${baseStyle} background: rgba(234, 179, 8, 0.2); border: 2px solid rgba(234, 179, 8, 0.5); color: #eab308; cursor: pointer;" onclick="leavePassengerSeat(${vIdx}, ${i})">
                            ${passengerName}<br><small>(clicca per lasciare)</small>
                        </div>`;
                    } else if (isAdmin) {
                        html += `<div style="${baseStyle} background: rgba(34, 197, 94, 0.2); border: 2px solid rgba(34, 197, 94, 0.5); color: #22c55e; cursor: pointer;" onclick="removePassengerAdmin(${vIdx}, ${i})">
                            ${passengerName}<br><small>(rimuovi)</small>
                        </div>`;
                    } else {
                        html += `<div style="${baseStyle} background: rgba(34, 197, 94, 0.2); border: 2px solid rgba(34, 197, 94, 0.5); color: #22c55e;">${passengerName}</div>`;
                    }
                } else {
                    if (amIAssigned) {
                        html += `<div style="${baseStyle} background: rgba(0,0,0,0.3); border: 2px dashed rgba(59, 130, 246, 0.3); color: #94a3b8; opacity: 0.5;">Libero</div>`;
                    } else {
                        html += `<div style="${baseStyle} background: rgba(0,0,0,0.3); border: 2px dashed rgba(59, 130, 246, 0.3); color: #94a3b8; cursor: pointer;" onclick="takePassengerSeat(${vIdx}, ${i})">Libero<br><small>(clicca per salire)</small></div>`;
                    }
                }
            }
            
            return html;
        }
        
        async function takeDriverSeat(vIdx) {
            const myId = getCurrentPlayerIdentifier();
            if (isPersonInAnyVehicle(myId)) {
                alert('Sei gi√† assegnato a un veicolo! Lascia prima il posto attuale.');
                return;
            }
            
            const player = playersList.find(p => p.number == myId);
            const myName = player ? `#${player.number} ${player.name}` : `#${myId}`;
            
            currentModalTrasporti.vehicles[vIdx].driver = myId;
            currentModalTrasporti.vehicles[vIdx].driverName = myName;
            
            await saveModalTrasporti();
            renderModalContent();
        }
        
        async function leaveDriverSeat(vIdx) {
            currentModalTrasporti.vehicles[vIdx].driver = '';
            currentModalTrasporti.vehicles[vIdx].driverName = '';
            
            await saveModalTrasporti();
            renderModalContent();
        }
        
        async function takePassengerSeat(vIdx, slotIdx) {
            const myId = getCurrentPlayerIdentifier();
            if (isPersonInAnyVehicle(myId)) {
                alert('Sei gi√† assegnato a un veicolo! Lascia prima il posto attuale.');
                return;
            }
            
            const player = playersList.find(p => p.number == myId);
            const myName = player ? `#${player.number} ${player.name}` : `#${myId}`;
            
            if (!currentModalTrasporti.vehicles[vIdx].passengers) {
                currentModalTrasporti.vehicles[vIdx].passengers = [];
            }
            if (!currentModalTrasporti.vehicles[vIdx].passengerNames) {
                currentModalTrasporti.vehicles[vIdx].passengerNames = [];
            }
            
            currentModalTrasporti.vehicles[vIdx].passengers[slotIdx] = myId;
            currentModalTrasporti.vehicles[vIdx].passengerNames[slotIdx] = myName;
            
            await saveModalTrasporti();
            renderModalContent();
        }
        
        async function leavePassengerSeat(vIdx, slotIdx) {
            currentModalTrasporti.vehicles[vIdx].passengers[slotIdx] = '';
            currentModalTrasporti.vehicles[vIdx].passengerNames[slotIdx] = '';
            
            await saveModalTrasporti();
            renderModalContent();
        }
        
        async function removePassengerAdmin(vIdx, slotIdx) {
            if (!isAdmin) return;
            currentModalTrasporti.vehicles[vIdx].passengers[slotIdx] = '';
            currentModalTrasporti.vehicles[vIdx].passengerNames[slotIdx] = '';
            
            await saveModalTrasporti();
            renderModalContent();
        }
        
        async function removeVehicleModal(vIdx) {
            if (!isAdmin) return;
            if (!confirm('Rimuovere questo veicolo?')) return;
            
            currentModalTrasporti.vehicles.splice(vIdx, 1);
            
            await saveModalTrasporti();
            renderModalContent();
        }
        
        async function addMyVehicle() {
            const seats = parseInt(document.getElementById('newVehicleSeats').value);
            const myId = getCurrentPlayerIdentifier();
            const player = playersList.find(p => p.number == myId);
            const myName = player ? `#${player.number} ${player.name}` : `#${myId}`;
            
            const alreadyDriver = currentModalTrasporti.vehicles.some(v => 
                String(v.driver) === myId || (v.driverName && v.driverName.includes(`#${myId}`))
            );
            
            if (alreadyDriver) {
                alert('Sei gi√† autista di un altro veicolo!');
                return;
            }
            
            currentModalTrasporti.vehicles.forEach(v => {
                if (v.passengers) {
                    v.passengers = v.passengers.map((p, i) => {
                        if (String(p) === myId || (v.passengerNames && v.passengerNames[i] && v.passengerNames[i].includes(`#${myId}`))) {
                            if (v.passengerNames) v.passengerNames[i] = '';
                            return '';
                        }
                        return p;
                    });
                }
            });
            
            const maxId = currentModalTrasporti.vehicles.reduce((max, v) => Math.max(max, v.id || 0), 0);
            currentModalTrasporti.vehicles.push({
                id: maxId + 1,
                seats: seats,
                driver: myId,
                driverName: myName,
                passengers: [],
                passengerNames: [],
                notes: ''
            });
            
            await saveModalTrasporti();
            renderModalContent();
        }
        
        async function saveModalTrasporti() {
            if (!currentModalMatchId) return;
            
            try {
                await fetch(`${FIREBASE_URL}/trasporti/${currentModalMatchId}.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentModalTrasporti)
                });
            } catch (e) {
                console.error('Errore salvataggio:', e);
                alert('Errore nel salvataggio. Riprova.');
            }
        }
    </script>
    
    <style>
        /* Modal Trasporti */
        .trasporti-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 1rem;
        }
        .trasporti-modal.open { display: block; }
        .trasporti-modal-content {
            max-width: 800px;
            margin: 2rem auto;
            background: linear-gradient(135deg, #0f2847 0%, #1e3a5f 100%);
            border-radius: 16px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            overflow: hidden;
        }
        .trasporti-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }
        .trasporti-modal-header h2 {
            margin: 0;
            color: #60a5fa;
            font-size: 1.2rem;
        }
        .trasporti-modal-close {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3rem;
        }
        .trasporti-modal-body {
            padding: 1.5rem;
        }

        /* Modal Info Partita */
        .match-info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 1rem;
        }
        .match-info-modal.open { display: block; }
        .match-info-modal-content {
            max-width: 600px;
            margin: 2rem auto;
            background: linear-gradient(135deg, #0f2847 0%, #1e3a5f 100%);
            border-radius: 16px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            overflow: hidden;
        }
        .match-info-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }
        .match-info-modal-header h2 {
            margin: 0;
            color: #60a5fa;
            font-size: 1.2rem;
        }
        .match-info-modal-close {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3rem;
        }
        .match-info-modal-body {
            padding: 1.5rem;
        }
        .match-detail-row {
            display: flex;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .match-detail-row:last-child { border-bottom: none; }
        .match-detail-row strong {
            min-width: 120px;
            color: #60a5fa;
        }
        .match-detail-row span {
            color: #e2e8f0;
        }
        .match-info-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: rgba(59, 130, 246, 0.3);
            color: #60a5fa;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
            transition: all 0.2s;
        }
        .match-info-btn:hover {
            background: rgba(59, 130, 246, 0.5);
        }
        .match-map-btn {
            display: inline-block;
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            margin-top: 1rem;
        }
    </style>
</body>
</html>
